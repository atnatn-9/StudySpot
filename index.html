<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudySpot</title>
<!-- Fonts & Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<!-- LEAFLET MAPS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
    /* --- 1. Design Tokens --- */
    :root {
        --bg-color: #F2F4F1;
        --phone-bg: linear-gradient(180deg, #F2F4F1 0%, #E6E9E5 100%);
        --glass-surface: rgba(255, 255, 255, 0.65); 
        --glass-surface-hover: rgba(255, 255, 255, 0.85);
        --glass-border: 1px solid rgba(255, 255, 255, 0.6);
        --glass-shadow: 0 8px 32px 0 rgba(79, 94, 82, 0.08);
        --backdrop-blur: blur(25px);
        
        --text-white: #2A2A2A; 
        --text-muted: rgba(42, 42, 42, 0.65);
        
        --accent-sage: #7C8F7A;
        --accent-sage-dark: #4F5E52;
        
        --accent-cyan: #7C8F7A;
        --accent-purple: #4F5E52;
        --accent-gradient: linear-gradient(135deg, #7C8F7A 0%, #4F5E52 100%);
        
        --color-blue: #6B8CA8;   
        --color-green: #27ae60;   
        --color-orange: #D4A373; 
        --color-red: #C85555;
        --google-blue: #4285F4;
        
        --xp-track: rgba(0,0,0,0.06);
        --xp-text: rgba(0,0,0,0.5);
    }

    [data-theme="dark"] {
        --bg-color: #0F1512;
        --phone-bg: radial-gradient(circle at 50% 0%, #1a221f 0%, #0F1512 80%);
        --glass-surface: rgba(30, 35, 32, 0.75); 
        --glass-surface-hover: rgba(50, 60, 55, 0.85);
        --glass-border: 1px solid rgba(255, 255, 255, 0.08);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        --text-white: #EAEAEA;
        --text-muted: rgba(255, 255, 255, 0.55);
        --accent-sage: #8FAF9C;
        --accent-sage-dark: #5E7A68;
        --accent-cyan: #8FAF9C; 
        --accent-purple: #A7C4AE;
        --accent-gradient: linear-gradient(135deg, #8FAF9C 0%, #5d7a6f 100%);
        --color-blue: #8AB4D5;
        --color-green: #2ecc71;
        --color-orange: #E6B88A;
        --color-red: #E07A7A;
        --xp-track: rgba(255,255,255,0.1);
        --xp-text: rgba(255,255,255,0.6);
    }

    html { font-size: clamp(12px, 2.3vw, 16px); }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    
    body { 
        background-color: #111 !important; 
        display: flex; justify-content: center; align-items: center; min-height: 100vh; 
        background-image: none;
    }

    #app-frame {
        width: 100%; max-width: 430px; height: 100vh; max-height: 100vh; margin: auto; border-radius: 32px;
        background: var(--phone-bg); position: relative; overflow: hidden;
        box-shadow: 0 0 0 12px #222, 0 20px 50px rgba(0,0,0,0.5); transition: background 0.5s ease; color: var(--text-white);
    }
    
    .orb { position: absolute; border-radius: 50%; filter: blur(90px); z-index: 0; opacity: 0.6; }
    .orb-1 { width: 350px; height: 350px; background: #A7B8A2; top: -100px; left: -80px; opacity: 0.5; }
    .orb-2 { width: 300px; height: 300px; background: #D1D8D0; bottom: -50px; right: -50px; opacity: 0.6; }
    [data-theme="dark"] .orb-1 { background: #2f3d36; opacity: 0.4; }
    [data-theme="dark"] .orb-2 { background: #1c2923; opacity: 0.4; }

    .dynamic-island { position: absolute; top: 11px; left: 50%; transform: translateX(-50%); width: 120px; height: 35px; background-color: #1a1a1a; border-radius: 20px; z-index: 1000; pointer-events: none; }

    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 1; overflow: hidden; color: var(--text-white); }
    .screen.active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.22, 1, 0.36, 1); }
    .scroll-view { flex: 1; overflow-y: auto; width: 100%; padding-bottom: 120px; scrollbar-width: none; height: calc(100vh - 150px); }
    .scroll-view::-webkit-scrollbar { display: none; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

    .col { display: flex; flex-direction: column; }
    .row { display: flex; flex-direction: row; }
    .center { align-items: center; justify-content: center; }
    .mb-16 { margin-bottom: 16px; }
    h1 { font-size: 26px; font-weight: 800; color: var(--text-white); letter-spacing: -0.5px; } 
    h2 { font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--text-white); } 
    p { font-size: 14px; color: var(--text-muted); }

    .btn { display: flex; align-items: center; justify-content: center; padding: 14px 20px; border-radius: 16px; font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.3s; border: none; outline: none; gap: 8px; }
    .btn-glass { background: var(--glass-surface); backdrop-filter: blur(12px); border: var(--glass-border); color: var(--text-white); box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    [data-theme="light"] .btn-glass { background: rgba(255,255,255,0.6); }
    [data-theme="dark"] .btn-glass { background: rgba(255,255,255,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .btn-glass:active { transform: scale(0.96); background: var(--glass-surface-hover); }
    
    .btn-primary { background: var(--accent-gradient); color: #fff; border: none; box-shadow: 0 8px 20px rgba(79, 94, 82, 0.25); border-radius: 30px; font-weight: 700; }
    .btn-primary:active { transform: scale(0.96); opacity: 0.95; }

    .btn-back { position: absolute; top: 50px; left: 24px; width: 44px; height: 44px; border-radius: 14px; background: rgba(255,255,255,0.6); backdrop-filter: blur(12px); border: var(--glass-border); display: flex; align-items: center; justify-content: center; color: var(--text-white); cursor: pointer; z-index: 2000; transition: 0.2s; box-shadow: var(--glass-shadow); }
    .btn-back:active { transform: scale(0.9); }

    .input-glass, .select-glass { width: 100%; padding: 16px; border-radius: 18px; background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.05); color: var(--text-white); font-size: 15px; outline: none; margin-bottom: 16px; transition: 0.3s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
    [data-theme="light"] .input-glass { background: rgba(255,255,255,0.5); border-color: rgba(0,0,0,0.05); }
    [data-theme="dark"] .input-glass { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); box-shadow: none; }
    .input-glass:focus { background: rgba(255,255,255,0.8); border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(124, 143, 122, 0.15); }
    textarea.input-glass { resize: none; height: 80px; font-family: 'Inter', sans-serif; }

    /* Compact Search Bar */
    .search-bar-glass { 
        background: rgba(255,255,255,0.4); 
        padding: 10px 14px; 
        border-radius: 18px; 
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.02); 
        margin-bottom: 12px; 
        gap: 10px; 
        align-items: center; 
        border: 1px solid rgba(255,255,255,0.5); 
        backdrop-filter: blur(5px); 
    }
    [data-theme="dark"] .search-bar-glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); box-shadow: none; }
    ::placeholder { color: var(--text-muted); opacity: 1; }

    /* FIXED: Filter Margin */
    .filter-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }
    .filter-icon {
        width: 40px;
        height: 40px;
        border-radius: 14px;
        background: rgba(255,255,255,0.5);
        border: 1px solid rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-sage);
        flex-shrink: 0;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
    }
    [data-theme="dark"] .filter-icon { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
    .chip-scroll { 
        display: flex; gap: 10px; overflow-x: auto; 
        padding-bottom: 4px; 
        scrollbar-width: none; 
        flex: 1;
    }
    .chip { padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.05); color: var(--text-muted); white-space: nowrap; transition: 0.3s; cursor: pointer; backdrop-filter: blur(8px); }
    [data-theme="dark"] .chip { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
    .chip.active { background: var(--accent-gradient); color: #fff; border-color: transparent; box-shadow: 0 4px 15px rgba(79, 94, 82, 0.3); }

    /* --- ANIMATED CAFE CARD --- */
    @keyframes cardSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .cafe-card { 
        background: var(--glass-surface); 
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
        border: var(--glass-border); 
        box-shadow: var(--glass-shadow); 
        border-radius: 24px; 
        padding: 14px; 
        display: flex; 
        align-items: flex-start; 
        gap: 12px; 
        margin: 0 24px 14px 24px; 
        cursor: pointer; 
        transition: transform 0.2s, background 0.2s;
        animation: cardSlideUp 0.5s ease-out forwards;
        opacity: 0; 
        position: relative;
    }
    .cafe-card:active { transform: scale(0.97); background: var(--glass-surface-hover); }
    
    .card-img { width: 85px; height: 85px; border-radius: 18px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0; }
    
    .card-info { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow: hidden; }
    
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card-title { font-weight: 700; font-size: 15px; color: var(--text-white); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    .card-title-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .card-metrics-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .metric-pill { display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: rgba(255,255,255,0.25); color: var(--text-white); white-space: nowrap; }
    [data-theme="dark"] .metric-pill { background: rgba(255,255,255,0.08); }
    .card-meta-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .meta-item { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
    .meta-item.meta-muted { opacity: 0.7; }
    .status-open-text { color: var(--color-green) !important; }
    .status-closed-text { color: var(--color-red) !important; }
    .card-meta-row .btn-card-go { margin-left: auto; }
    .card-rank-badge { width: 34px; height: 34px; border-radius: 12px; background: rgba(255,255,255,0.7); border: var(--glass-border); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--accent-sage-dark); flex-shrink: 0; }
    [data-theme="dark"] .card-rank-badge { background: rgba(255,255,255,0.05); color: var(--accent-sage); border-color: rgba(255,255,255,0.1); }
    
    /* Live Status Pulse Animation */
    @keyframes statusPulse { 0% { opacity: 0.6; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.6; transform: scale(0.95); } }
    .status-badge { 
        padding: 4px 10px; border-radius: 12px; 
        font-size: 10px; font-weight: 700; 
        background: rgba(255,255,255,0.8); 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        white-space:nowrap; display: flex; align-items: center; gap: 4px;
        flex-shrink: 0;
    }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: statusPulse 2s infinite; flex-shrink: 0; }

    /* New "Pill" Tags for readability */
    .card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 2px; }
    .info-tag { 
        display: flex; align-items: center; gap: 4px; 
        padding: 4px 8px; border-radius: 8px; 
        font-size: 10px; font-weight: 600; 
        background: rgba(0,0,0,0.04); 
        border: 1px solid rgba(0,0,0,0.04);
    }
    [data-theme="dark"] .info-tag { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.05); }
    
    .crowd-visual { display: flex; align-items: center; gap: 6px; font-size: 10px; font-weight: 600; margin-top: 2px; }
    .crowd-bar-bg { width: 60px; height: 4px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
    [data-theme="dark"] .crowd-bar-bg { background: rgba(255,255,255,0.1); }
    .crowd-bar-fill { height: 100%; border-radius: 4px; }
    
    /* UPDATED: Go Shortcut Button */
    .btn-card-go {
        height: 36px; padding: 0 16px; border-radius: 18px;
        background: var(--accent-gradient); color: #fff;
        display: flex; align-items: center; justify-content: center; gap: 6px;
        font-size: 12px; font-weight: 700; flex-shrink: 0;
        cursor: pointer; box-shadow: 0 4px 15px rgba(79, 94, 82, 0.25);
        transition: 0.2s;
    }
    .btn-card-go.disabled { background: rgba(255,255,255,0.2); color: var(--text-muted); box-shadow: none; }
    .btn-card-go:active { transform: scale(0.95); opacity: 0.9; }
    .btn-card-go .go-icon { display: inline-flex; transform: scaleX(-1); }
    
    .unlock-block { margin: 20px 24px; padding: 30px; border-radius: 24px; background: rgba(255,255,255,0.4); border: 1px dashed rgba(0,0,0,0.15); text-align: center; backdrop-filter: blur(5px); }
    [data-theme="light"] .unlock-block { background: rgba(255,255,255,0.4); border-color: rgba(0,0,0,0.1); }
    [data-theme="dark"] .unlock-block { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.1); }

    .hero-section { position: relative; width: 100%; height: 320px; }
    #detail-title { color: #FFFFFF !important; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .status-row { display: flex; gap: 10px; align-items: center; font-size: 14px; font-weight: 700; text-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .status-open { color: var(--color-green); text-shadow:none; background: rgba(255,255,255,0.9); padding: 4px 10px; border-radius: 12px; }
    .status-closed { color: var(--color-red); text-shadow:none; background: rgba(255,255,255,0.9); padding: 4px 10px; border-radius: 12px; }
    .close-hour { color: #fff; opacity: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.4); }

    .btn-like-float { position: absolute; top: 50px; right: 24px; width: 44px; height: 44px; border-radius: 50%; background: var(--accent-sage-dark); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2000; border: none; transition: transform 0.2s; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .btn-like-float:active { transform: scale(0.9); }

    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 20px 0; }
    .info-box { background: var(--glass-surface); border: var(--glass-border); backdrop-filter: blur(10px); padding: 16px; border-radius: 20px; text-align: center; display: flex; flex-direction: column; gap: 6px; }
    .info-value { font-weight: 700; font-size: 15px; }

    .chart-box { background: var(--glass-surface); border: var(--glass-border); backdrop-filter: blur(10px); padding: 20px; border-radius: 24px; box-shadow: var(--glass-shadow); margin-bottom: 24px; }
    .chart-bars { display: flex; align-items: flex-end; justify-content: space-between; height: 100px; padding-top: 20px; gap: 6px; }
    
    .bar-col { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; gap: 4px; cursor: pointer; position: relative; }
    .bar { width: 100%; border-radius: 6px 6px 0 0; min-height: 10px; opacity: 0.6; background: var(--text-muted); transition: 0.3s; }
    .bar-label { font-size: 9px; color: var(--text-muted); }
    .bar-col.active .bar { opacity: 1; background: var(--accent-gradient); box-shadow: 0 0 15px rgba(124, 143, 122, 0.4); }
    
    select { color: var(--text-white); background-color: rgba(255,255,255,0.5); backdrop-filter: blur(10px); border:none; }
    select option { background-color: #F2F4F1; color: #2A2A2A; padding: 10px; }
    [data-theme="light"] select option { background-color: #FFFFFF; color: #333333; }
    [data-theme="dark"] select option { background-color: #0F1512; color: #EAEAEA; }

    .timeline { position: relative; padding-left: 20px; border-left: 2px solid rgba(0,0,0,0.1); margin-left: 10px; display: flex; flex-direction: column; gap: 20px; }
    [data-theme="dark"] .timeline { border-left-color: rgba(255,255,255,0.1); }
    .timeline-item { position: relative; animation: slideUp 0.3s ease-out; }
    .timeline-dot { position: absolute; left: -26px; top: 4px; width: 10px; height: 10px; border-radius: 50%; background: var(--accent-cyan); box-shadow: 0 0 8px rgba(124, 143, 122, 0.4); }
    .comment-box { background: var(--glass-surface); border: var(--glass-border); padding: 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; color: var(--text-white); }
    
    .contribution-img { width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover; margin-top: 10px; border: 1px solid rgba(255,255,255,0.4); cursor: pointer; transition: 0.2s; background: rgba(0,0,0,0.05); }
    [data-theme="dark"] .contribution-img { border-color: rgba(255,255,255,0.1); }
    .contribution-img:active { transform: scale(0.98); opacity: 0.8; }

    /* --- GALLERY GRID & SHOW MORE --- */
    .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
    .gallery-item-wrapper { position: relative; width: 100%; aspect-ratio: 1; border-radius: 12px; overflow: hidden; cursor: pointer; background: rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5); }
    [data-theme="dark"] .gallery-item-wrapper { border-color: rgba(255,255,255,0.1); }
    .gallery-item { width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s; }
    .gallery-item-wrapper:active .gallery-item { transform: scale(0.95); }
    .more-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 13px; font-weight: 700; backdrop-filter: blur(2px); }
    .gallery-category { margin-top: 12px; }
    .gallery-category-title { display: flex; align-items: center; gap: 8px; color: var(--text-white); font-weight: 700; font-size: 13px; margin: 6px 0; }
    .gallery-category-title .category-count { color: var(--text-muted); font-weight: 600; font-size: 11px; }
    .gallery-tabs-wrapper { display: flex; flex-direction: column; align-items: center; gap: 4px; margin: 6px auto 4px; }
    .gallery-tab-bar { display: flex; gap: 10px; justify-content: center; align-items: center; max-width: 360px; flex-wrap: nowrap; }
    .gallery-tab { border: 1px solid rgba(255,255,255,0.35); background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1)); color: var(--text-white); border-radius: 14px; padding: 10px 12px; font-weight: 700; font-size: 12px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(10px); display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
    .gallery-tab .label { white-space: nowrap; }
    .gallery-tab .category-count { color: var(--text-muted); font-weight: 600; font-size: 11px; }
    .gallery-tab i { font-size: 14px; opacity: 0.85; }
    .gallery-tab:hover { border-color: rgba(255,255,255,0.35); transform: none; }
    .gallery-tab.active { background: var(--accent-gradient); border-color: transparent; box-shadow: 0 10px 24px rgba(79, 94, 82, 0.45); }
    .gallery-tab:disabled { opacity: 0.35; cursor: not-allowed; border-style: dashed; transform: none; }
    .gallery-tab-hint { color: var(--text-muted); font-size: 12px; text-align: center; }

    .compare-grid { display: grid; grid-template-columns: 1fr 1px 1fr; gap: 10px; text-align: center; }
    .compare-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: transparent; border-radius: 12px; cursor: pointer; border: 1px solid transparent; color: var(--text-white); }
    .compare-item:hover { border-color: var(--accent-cyan); background: var(--glass-surface); }
    .cmp-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }

    /* --- LIGHTBOX --- */
    .lightbox-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(15px); opacity: 0; transition: opacity 0.3s; }
    .lightbox-overlay.active { display: flex; opacity: 1; }
    .lightbox-img { max-width: 100%; max-height: 70%; border-radius: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transition: opacity 0.2s; }
    .lightbox-close { position: absolute; top: 40px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); z-index: 5002; }
    .lightbox-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 44px; height: 44px; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; z-index: 5001; backdrop-filter: blur(10px); }
    .lightbox-prev { left: 16px; }
    .lightbox-next { right: 16px; }
    .lightbox-dots { position: absolute; bottom: 40px; display: flex; gap: 8px; z-index: 5001; }
    .lightbox-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255, 255, 255, 0.4); transition: 0.3s; }
    .lightbox-dot.active { background: #fff; transform: scale(1.2); }

    /* --- NAVIGATION --- */
    .bottom-nav { position: absolute; bottom: 20px; left: 20px; right: 20px; width: auto; height: 70px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.9); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; z-index: 900; transition: transform 0.3s ease-out; box-shadow: 0 10px 40px rgba(79, 94, 82, 0.15); }
    [data-theme="light"] .bottom-nav { background: rgba(255, 255, 255, 0.85); border: 1px solid rgba(255,255,255,0.9); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    [data-theme="dark"] .bottom-nav { background: rgba(15, 21, 18, 0.85); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    
    /* DETAIL SCREEN ACTION BAR - MINIMALIST */
    .detail-bottom-nav { 
        position: absolute; bottom: 30px; left: 24px; right: 24px; height: 64px; 
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
        border-radius: 20px; display: flex; align-items: center; justify-content: space-between; 
        padding: 0 8px; gap: 8px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); z-index: 950;
    }
    [data-theme="dark"] .detail-bottom-nav { background: rgba(30, 30, 30, 0.85); box-shadow: 0 15px 35px rgba(0,0,0,0.5); }

    /* Minimalist Buttons */
    .btn-minimal {
        flex: 1; height: 44px; border-radius: 12px; font-size: 12px; font-weight: 600;
        display: flex; align-items: center; justify-content: center; border: none;
        transition: 0.2s; background: rgba(0,0,0,0.03); color: var(--text-white); cursor: pointer;
    }
    [data-theme="dark"] .btn-minimal { background: rgba(255,255,255,0.05); }
    .btn-minimal:active { transform: scale(0.96); opacity: 0.8; }

    @keyframes checkinFade {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes checkinPulse {
        0% { box-shadow: 0 0 0 rgba(124, 143, 122, 0.0); filter: brightness(1); }
        50% { box-shadow: 0 10px 22px rgba(79, 94, 82, 0.35); filter: brightness(1.08); }
        100% { box-shadow: 0 0 0 rgba(124, 143, 122, 0.0); filter: brightness(1); }
    }
    .btn-minimal.checkin-cta {
        position: relative;
        font-weight: 800;
        letter-spacing: 0.2px;
        color: #fff;
        background: var(--accent-gradient);
        border: 1px solid rgba(255,255,255,0.35);
        box-shadow: 0 12px 26px rgba(79, 94, 82, 0.35);
        overflow: hidden;
    }
    .btn-minimal.checkin-cta.attention {
        animation: checkinFade 0.45s ease-out, checkinPulse 2.4s ease-in-out infinite;
    }
    [data-theme="dark"] .btn-minimal.checkin-cta.attention {
        animation: checkinFade 0.45s ease-out, checkinPulse 2.4s ease-in-out infinite;
    }
    .btn-minimal.checkin-cta::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.35) 40%, rgba(255,255,255,0) 70%);
        transform: translateX(-120%);
        opacity: 0.7;
    }
    .btn-minimal.checkin-cta.attention::after {
        animation: checkinShimmer 2.8s ease-in-out infinite;
    }
    @keyframes checkinShimmer {
        0% { transform: translateX(-120%); }
        60% { transform: translateX(120%); }
        100% { transform: translateX(120%); }
    }

    .btn-minimal-primary {
        flex: 1.2; height: 44px; border-radius: 12px; font-size: 12px; font-weight: 700;
        background: var(--text-white); color: var(--bg-color); border: none; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center;
    }
    [data-theme="dark"] .btn-minimal-primary { background: #fff; color: #000; }
    .btn-minimal-primary:active { transform: scale(0.96); }

    .nav-icon { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 10px; font-weight: 500; cursor: pointer; width: 20%; }
    .nav-icon i { font-size: 24px; margin-bottom: 2px; transition: 0.2s; }
    .nav-icon.active { color: var(--accent-sage-dark); }
    [data-theme="light"] .nav-icon.active { color: var(--accent-sage-dark); }
    [data-theme="dark"] .nav-icon.active { color: var(--accent-sage); }
    .nav-icon.active i { transform: translateY(-4px); filter: drop-shadow(0 4px 6px rgba(124, 143, 122, 0.3)); }
    [data-theme="light"] .nav-icon.active i { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }

    .profile-avatar { width: 110px; height: 110px; border-radius: 50%; background: rgba(255,255,255,0.5); border: 3px solid rgba(255,255,255,0.6); box-shadow: 0 8px 30px rgba(124, 143, 122, 0.2); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; position: relative; z-index: 1; font-size: 40px; color: var(--text-muted); }
    [data-theme="dark"] .profile-avatar { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
    .profile-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

    .level-badge { background: var(--accent-gradient); padding: 4px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; color: #fff; margin-top: 4px; display: inline-block; box-shadow: 0 4px 15px rgba(124, 143, 122, 0.4); }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; width: 100%; margin-bottom: 30px; }
    .stat-card { background: var(--glass-surface); border: var(--glass-border); border-radius: 20px; padding: 16px 8px; display: flex; flex-direction: column; align-items: center; gap: 4px; box-shadow: var(--glass-shadow); }
    .ranking-card { width: 100%; background: var(--glass-surface); border: var(--glass-border); border-radius: 22px; padding: 16px; box-shadow: var(--glass-shadow); }
    .ranking-header { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
    .ranking-title { font-size: 16px; font-weight: 700; color: var(--text-white); }
    .ranking-sub { font-size: 11px; color: var(--text-muted); }
    .ranking-list { display: flex; flex-direction: column; gap: 10px; }
    .ranking-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 14px; background: rgba(255,255,255,0.35); border: 1px solid rgba(0,0,0,0.05); }
    [data-theme="dark"] .ranking-item { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); }
    .ranking-item.you { border-color: var(--accent-cyan); box-shadow: 0 0 0 1px rgba(124, 143, 122, 0.25); }
    .ranking-item.top-1 { background: linear-gradient(135deg, rgba(212, 163, 115, 0.35), rgba(255,255,255,0.5)); border-color: rgba(212, 163, 115, 0.5); }
    .ranking-item.top-2 { background: linear-gradient(135deg, rgba(190, 199, 206, 0.35), rgba(255,255,255,0.5)); border-color: rgba(190, 199, 206, 0.5); }
    .ranking-item.top-3 { background: linear-gradient(135deg, rgba(182, 143, 108, 0.35), rgba(255,255,255,0.5)); border-color: rgba(182, 143, 108, 0.5); }
    [data-theme="dark"] .ranking-item.top-1 { background: linear-gradient(135deg, rgba(212, 163, 115, 0.18), rgba(255,255,255,0.06)); }
    [data-theme="dark"] .ranking-item.top-2 { background: linear-gradient(135deg, rgba(190, 199, 206, 0.18), rgba(255,255,255,0.06)); }
    [data-theme="dark"] .ranking-item.top-3 { background: linear-gradient(135deg, rgba(182, 143, 108, 0.18), rgba(255,255,255,0.06)); }
    .ranking-rank { width: 28px; height: 28px; border-radius: 10px; background: rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--accent-sage-dark); }
    [data-theme="dark"] .ranking-rank { background: rgba(255,255,255,0.08); color: var(--accent-sage); }
    .ranking-avatar { width: 34px; height: 34px; border-radius: 50%; background: rgba(0,0,0,0.06); display: flex; align-items: center; justify-content: center; color: var(--text-muted); flex-shrink: 0; overflow: hidden; }
    [data-theme="dark"] .ranking-avatar { background: rgba(255,255,255,0.08); }
    .ranking-meta { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .ranking-name { font-size: 13px; font-weight: 700; color: var(--text-white); }
    .ranking-detail { font-size: 11px; color: var(--text-muted); }
    .ranking-points { font-size: 12px; font-weight: 700; color: var(--accent-sage-dark); }
    [data-theme="dark"] .ranking-points { color: var(--accent-sage); }
    .xp-bar-bg { height: 10px; background: var(--xp-track); border-radius: 10px; overflow:hidden; }
    .xp-text-label { font-size:12px; margin-bottom:8px; color: var(--xp-text); font-weight: 600; }

    .avatar-edit-btn { position: absolute; bottom: 0; right: 0; width: 32px; height: 32px; background: var(--accent-cyan); border-radius: 50%; border: 3px solid #F2F4F1; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 14px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    [data-theme="dark"] .avatar-edit-btn { border-color: #0F1512; color: #0F1512; }
    .avatar-edit-btn:active { transform: scale(0.9); }

    .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
    .modal-card { width: 90%; background: rgba(255, 255, 255, 0.85); border: 1px solid rgba(255,255,255,0.9); padding: 30px 24px; border-radius: 32px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); text-align: center; animation: slideUp 0.3s ease-out; color: var(--text-white); }
    [data-theme="light"] .modal-card { background: rgba(255,255,255,0.9); border-color: #fff; box-shadow: 0 20px 60px rgba(0,0,0,0.1); color: #333; }
    [data-theme="dark"] .modal-card { background: #1a201d; border-color: rgba(255,255,255,0.1); box-shadow: 0 20px 60px rgba(0,0,0,0.7); }
    .checkin-header { text-align: center; margin-bottom: 18px; }
    .checkin-title { font-size: 18px; font-weight: 800; letter-spacing: -0.2px; margin-bottom: 6px; }
    .checkin-sub { font-size: 12px; color: var(--text-muted); line-height: 1.4; }
    .checkin-bonus {
        font-size: 11px;
        font-weight: 700;
        color: #fff;
        margin-top: 8px;
        padding: 6px 10px;
        border-radius: 10px;
        display: inline-flex;
        gap: 6px;
        align-items: center;
        background: linear-gradient(135deg, #7C8F7A 0%, #4F5E52 100%);
        box-shadow: 0 6px 14px rgba(79, 94, 82, 0.25);
    }
    .checkin-bonus::before {
        content: "Bonus";
        font-size: 10px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        padding: 2px 6px;
        border-radius: 6px;
        background: rgba(255,255,255,0.2);
    }
    .unlock-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin-top: 12px;
    }
    .unlock-pill {
        padding: 6px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        color: var(--text-white);
        background: rgba(255,255,255,0.25);
        border: 1px solid rgba(255,255,255,0.35);
    }

    @keyframes rankPop {
        0% { transform: translateX(-50%) translateY(-14px) scale(0.9); opacity: 0; }
        55% { transform: translateX(-50%) translateY(2px) scale(1.05); opacity: 1; }
        100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
    }
    @keyframes rankGlow {
        0%, 100% { box-shadow: 0 18px 45px rgba(225, 100, 90, 0.45), 0 0 0 3px rgba(255,255,255,0.25); }
        50% { box-shadow: 0 24px 55px rgba(225, 100, 90, 0.6), 0 0 0 5px rgba(255,255,255,0.35); }
    }
    .rank-toast {
        position: absolute;
        left: 50%;
        top: 84px;
        transform: translateX(-50%) translateY(-14px) scale(0.9);
        background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.35), rgba(255,255,255,0) 40%), linear-gradient(135deg, #F8C57A 0%, #E1645A 55%, #C85555 100%);
        color: #fff;
        padding: 16px 26px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        backdrop-filter: blur(6px);
        border: 1px solid rgba(255,255,255,0.35);
        opacity: 0;
        pointer-events: none;
        z-index: 2200;
    }
    .rank-toast::before {
        content: "â˜…";
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        margin-right: 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.25);
        font-size: 14px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.35);
    }
    .rank-toast::after {
        content: "";
        position: absolute;
        inset: -6px;
        border-radius: 26px;
        background: conic-gradient(from 120deg, rgba(255,255,255,0.35), rgba(255,255,255,0), rgba(255,255,255,0.25));
        z-index: -1;
        filter: blur(10px);
        opacity: 0.75;
    }
    .rank-toast.show {
        animation: rankPop 0.5s cubic-bezier(0.22, 1, 0.36, 1), rankGlow 1.6s ease-in-out infinite;
        opacity: 1;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .input-bars { display: flex; gap: 4px; height: 30px; margin-bottom: 8px; align-items: flex-end; }
    .input-bar { flex: 1; background: rgba(0,0,0,0.08); border-radius: 4px; cursor: pointer; transition: 0.2s; }
    [data-theme="dark"] .input-bar { background: rgba(255,255,255,0.1); }
    .input-bar.filled { background: var(--accent-cyan); box-shadow: 0 0 10px rgba(124, 143, 122, 0.3); }
    
    .btn-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.6); box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; border: var(--glass-border); outline: none;}
    .btn-icon:active { transform: scale(0.9); }

    .achievements-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 4px 4px 16px 4px; scrollbar-width: none; }
    .achievements-scroll::-webkit-scrollbar { display: none; }
    .achievement-card { min-width: 160px; width: 160px; background: rgba(255, 255, 255, 0.55); border: var(--glass-border); border-radius: 20px; padding: 16px; display: flex; flex-direction: column; gap: 8px; box-shadow: var(--glass-shadow); position: relative; transition: 0.3s; backdrop-filter: blur(10px); }
    [data-theme="dark"] .achievement-card { background: rgba(255,255,255,0.03); }
    .achievement-card.locked { opacity: 0.6; filter: grayscale(0.8); }
    .achievement-icon-box { width: 36px; height: 36px; border-radius: 10px; background: rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    [data-theme="dark"] .achievement-icon-box { background: rgba(255,255,255,0.1); }

    @media (min-width: 768px) {
        body { background-color: #000000 !important; display: flex !important; justify-content: center !important; align-items: center !important; min-height: 100vh !important; margin: 0 !important; padding: 20px !important; box-sizing: border-box !important; }
        #app-frame { width: 100% !important; max-width: 430px !important; height: 90vh !important; max-height: 932px !important; border-radius: 48px !important; box-shadow: 0 0 0 14px #1a1a1a, 0 30px 60px rgba(0,0,0,0.6) !important; margin: auto !important; position: relative !important; overflow: hidden !important; }
    }

    @media (max-width: 768px) {
        .phone-frame { display: none !important; }
        .dynamic-island, .phone-notch, .notch { display: none !important; }
        #app-frame { width: 100vw; height: 100vh; border-radius: 0; box-shadow: none; max-width: none; max-height: none; margin: 0; border: none; }
    }

    .cafe-carousel { position: relative; width: 100%; height: 100%; border-radius: 16px; overflow: hidden; }
    .carousel-image { width: 100%; height: 100%; background-size: cover !important; background-position: center !important; }
    .carousel-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 42px; height: 42px; border-radius: 50%; background: rgba(255,255,255,0.28); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.4); color: white; font-size: 22px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; display: none; }
    .left-arrow { left: 10px; }
    .right-arrow { right: 10px; }
    .carousel-arrow:active { transform: translateY(-50%) scale(0.92); }
    
    /* NEW: Floating Segmented Control (Toggle) */
    .toggle-container {
        position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
        padding: 4px; border-radius: 30px;
        display: flex; gap: 4px; z-index: 100;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    [data-theme="dark"] .toggle-container { background: rgba(30, 30, 30, 0.9); }

    .toggle-btn {
        padding: 8px 24px; border-radius: 24px;
        font-size: 13px; font-weight: 600;
        border: none; background: transparent;
        color: var(--text-muted);
        cursor: pointer; transition: 0.2s;
        display: flex; align-items: center; gap: 6px;
    }
    
    .toggle-btn.active {
        background: var(--text-white); color: var(--bg-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Map Elements */
    .marker-pin {
        width: 34px; height: 34px; border-radius: 50%; border: 3px solid #fff;
        display: flex; align-items: center; justify-content: center;
        color: #fff; font-weight: 700; font-size: 11px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .user-dot {
        width: 18px; height: 18px; background: #2F80ED;
        border: 3px solid #fff; border-radius: 50%;
        box-shadow: 0 0 0 10px rgba(47, 128, 237, 0.2);
        animation: pulseUser 2s infinite;
    }
    @keyframes pulseUser { 0% { box-shadow: 0 0 0 0 rgba(47, 128, 237, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(47, 128, 237, 0); } 100% { box-shadow: 0 0 0 0 rgba(47, 128, 237, 0); } }

    /* REFINED COMPARE LIST - FULL SCREEN */
    #screen-compare-select .modal-card {
        width: 100%; height: 100%; max-height: 100%; border-radius: 0;
        display: flex; flex-direction: column; padding: 24px;
        background: var(--bg-color);
    }
    .compare-item-list {
        flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
        padding-bottom: 20px;
    }
    .compare-item {
        background: var(--glass-surface); border: var(--glass-border);
        padding: 12px; border-radius: 16px;
        display: flex; align-items: center; gap: 12px;
        transition: 0.2s;
    }
    .compare-item:active { transform: scale(0.98); background: var(--glass-surface-hover); }

</style>
</head>
<body>
<div id="app-frame">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="dynamic-island"></div>

<!-- === SCREEN 1: HOME (WITH MAP TOGGLE) === -->
<div id="screen-home" class="screen active">
    <div class="col" style="padding: 50px 24px 0px; z-index: 50;" id="home-header">
        <div class="row center mb-16" style="gap: 10px; justify-content: flex-start; margin-bottom: 8px !important;">
            <i class="ph-fill ph-coffee" style="font-size: 28px; color: var(--accent-cyan);"></i>
            <h1 style="margin: 0;">StudySpot</h1>
        </div>

        <p style="margin-bottom: 12px; font-size: 13px;">Find the best workspace for you</p>
        <div class="row search-bar-glass">
            <i class="ph ph-magnifying-glass" style="color: var(--text-muted); font-size: 20px;"></i>
            <input type="text" placeholder="Search cafes..." onkeyup="handleSearch(this.value)" style="background:transparent; border:none; color:var(--text-white); width:100%; outline:none;">
        </div>
        <div class="filter-bar">
            <div class="filter-icon">
                <i class="ph-bold ph-faders" style="font-size: 18px;"></i>
            </div>
            <div class="chip-scroll">
                <div class="chip active" onclick="filterList('All', this)">All</div>
                <div class="chip" onclick="filterList('Crowd', this)">Crowd</div>
                <div class="chip" onclick="filterList('Wifi', this)">Wifi</div>
                <div class="chip" onclick="filterList('Drinks', this)">Drinks</div>
                <div class="chip" onclick="filterList('Service', this)">Service</div>
                <div class="chip" onclick="filterList('Price', this)">Price</div>
                <div class="chip" onclick="filterList('Distance', this)">Distance</div>
            </div>
        </div>
    </div>
    
    <!-- LIST VIEW CONTAINER -->
    <div class="scroll-view" id="home-list-view">
        <div id="cafe-list-container"></div>
        <div class="unlock-block" id="home-unlock-block">
            <h2 style="font-size: 16px; color: var(--text-white);">Unlock more cafes</h2>
            <p class="mb-16" style="font-size: 12px;">Reach Top 3 and above on the leaderboard to unlock more places. Higher rank unlocks more cafes.</p>
            <div class="row center" style="gap: 12px;">
                <button class="btn btn-glass" onclick="openLoginModal()">Sign In</button>
                <button class="btn btn-primary" onclick="openCheckInModal()">Check-In</button>
            </div>
        </div>
    </div>

    <!-- MAP VIEW CONTAINER -->
    <div id="home-map-view" style="display: none; width: 100%; height: 100vh; position: relative; z-index: 1;">
        <div id="discovery-map" style="width: 100%; height: 100%;"></div>
    </div>

    <!-- REFINED FLOATING TOGGLE -->
    <div class="toggle-container">
        <button class="toggle-btn active" id="btn-list-mode" onclick="setHomeMode('list')">
            <i class="ph-fill ph-list-dashes"></i> List
        </button>
        <button class="toggle-btn" id="btn-map-mode" onclick="setHomeMode('map')">
            <i class="ph-fill ph-map-trifold"></i> Map
        </button>
    </div>
</div>

<!-- === SCREEN 2: SAVED === -->
<div id="screen-saved" class="screen">
    <div class="col" style="padding: 60px 24px 20px;"><h1>Saved Spots</h1></div>
    <div class="scroll-view"><div id="saved-container" class="col"></div></div>
</div>

<!-- === SCREEN 5: ACCOUNT === -->
<div id="screen-account" class="screen">
    <div id="account-scroll" class="scroll-view">
        <div id="account-content" class="col center" style="width: 100%;"></div>
    </div>
</div>

<!-- === SCREEN 6: ACTIVITY === -->
<div id="screen-activity" class="screen">
    <div class="col" style="padding: 60px 24px 20px;"><h1>Activity</h1></div>
    <div class="scroll-view" style="padding: 0 24px;">
        <div class="col" style="gap: 16px;">
            <div style="background: var(--glass-surface); padding: 16px; border-radius: 20px; box-shadow: var(--glass-shadow); display: flex; gap: 12px; border: var(--glass-border); backdrop-filter: blur(10px);">
                <i class="ph-fill ph-check-circle" style="color: var(--accent-cyan); font-size: 24px;"></i>
                <div class="col"><span style="font-size: 14px; color: var(--text-white);"><b>Alex</b> checked in at <b>Corner Brew</b></span><span style="font-size: 11px; opacity: 0.6; color: var(--text-muted);">5 mins ago</span></div>
            </div>
        </div>
    </div>
</div>

<!-- === SCREEN 7: SETTINGS === -->
<div id="screen-settings" class="screen">
    <div class="col" style="padding: 60px 24px 20px;"><h1>Settings</h1></div>
    <div class="col" style="padding: 0 24px; gap: 12px;">
        <button class="btn btn-glass" style="justify-content: flex-start;">Account Details</button>
        <button class="btn btn-glass" style="justify-content: flex-start;">Notifications</button>
        <button class="btn btn-glass" style="justify-content: flex-start;">Privacy & Security</button>
        <button class="btn btn-glass" style="justify-content: flex-start;">Help & Support</button>
        
        <div class="col" style="margin-top: 10px; margin-bottom: 8px;">
            <span style="font-size: 14px; margin-left: 8px; margin-bottom: 4px; color: var(--text-muted);">Appearance</span>
            <div class="row" style="background: rgba(255,255,255,0.4); padding: 6px; border-radius: 14px; gap: 10px; border: var(--glass-border); backdrop-filter: blur(10px);">
                 <button class="btn btn-glass" style="flex:1; box-shadow:none; background:transparent; color: var(--text-muted);" onclick="setTheme('dark')">Dark</button>
                 <button class="btn btn-glass" style="flex:1; box-shadow:none; background:transparent; color: var(--text-muted);" onclick="setTheme('light')">Light</button>
            </div>
        </div>
        <div style="height: 10px;"></div>
        <button class="btn btn-glass" style="justify-content: center; color: var(--color-red);" onclick="logout()">Sign Out</button>
    </div>
</div>

<!-- === SCREEN: DETAIL === -->
<div id="screen-detail" class="screen">
    <div class="btn-back" onclick="navTo('screen-home')"><i class="ph-bold ph-arrow-left" style="font-size: 20px;"></i></div>
    
    <div class="btn-like-float" id="like-btn" onclick="toggleFavorite()">
        <i class="ph ph-heart" style="color: #fff; font-size: 20px;"></i>
    </div>
    
    <div class="scroll-view">
        <div class="hero-section">
            <div class="cafe-carousel">
                <div class="carousel-image" id="carouselImage"></div>
            </div>
            
            <div style="position: absolute; bottom: 30px; left: 24px; right: 24px; z-index: 60;">
                <h1 id="detail-title">Title</h1>
                <div class="status-row" id="detail-status">
                    <!-- Dynamic Status Here -->
                </div>
            </div>
        </div>

        <div class="detail-body" style="padding: 10px 24px 40px; position: relative; z-index: 20;">
            
            <div class="col" style="gap: 12px; margin-bottom: 24px; font-size: 14px; color: var(--text-muted);">
                <div class="row center" style="justify-content: flex-start; gap: 10px;">
                    <i class="ph-fill ph-map-pin" style="color: var(--accent-purple);"></i>
                    <span id="detail-address" style="color: var(--text-white);">Address</span>
                </div>
                <div class="row center" style="justify-content: flex-start; gap: 10px;">
                    <i class="ph-fill ph-phone" style="color: var(--accent-purple);"></i>
                    <span id="detail-hotline" style="color: var(--text-white);">Hotline</span>
                </div>
                 <div class="row center" style="justify-content: flex-start; gap: 10px;">
                    <i class="ph-fill ph-notebook" style="color: var(--accent-purple);"></i>
                    <span id="detail-note" style="color: var(--text-white);"></span>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-box"><span class="info-label">WiFi</span><span class="info-value" id="detail-wifi">Good</span></div>
                <div class="info-box"><span class="info-label">Drinks</span><span class="info-value" id="detail-drinks">Good</span></div>
                <div class="info-box"><span class="info-label">Service</span><span class="info-value" id="detail-service">Good</span></div>
                <div class="info-box"><span class="info-label">Price</span><span class="info-value" id="detail-price">$$</span></div>
            </div>

            <div class="chart-box">
                <div class="row" style="justify-content: space-between; margin-bottom: 15px; align-items: center;">
                    <h2 style="margin:0;">Crowd Levels</h2>
                    <select class="select-glass" style="width: auto; padding: 6px 12px; border-radius: 8px; margin:0; font-size: 12px;" id="chart-day-select">
                        <option value="Mon">Mon</option>
                        <option value="Tue">Tue</option>
                        <option value="Wed" selected>Wed</option>
                        <option value="Thu">Thu</option>
                        <option value="Fri">Fri</option>
                        <option value="Sat">Sat</option>
                        <option value="Sun">Sun</option>
                    </select>
                </div>
                <div class="chart-bars" id="crowd-chart"></div>
            </div>

            <div class="col" style="margin-top: 20px;">
                <h2>Community Contribution</h2>
                <div class="gallery-grid" id="community-gallery"></div>
                <div style="margin-top: 20px;" class="timeline" id="community-timeline"></div>
            </div>
        </div>
    </div>
    
    <!-- DETAIL BOTTOM NAV (UPDATED) -->
    <div class="detail-bottom-nav">
        <button class="btn-minimal" onclick="openCompareSelection()">Compare</button>
        <button id="checkin-btn" class="btn-minimal checkin-cta" onclick="openCheckInModal()">Check-In</button>
        <!-- Changed to direct Google Maps link -->
        <button class="btn-minimal-primary" onclick="openGoogleMaps()">Start Trip</button>
    </div>
</div>

<!-- === COMPARE SCREENS (UPDATED FULL SCREEN) === -->
<div id="screen-compare-select" class="modal-overlay">
    <div class="modal-card">
        <div class="row center" style="justify-content: space-between; width:100%; margin-bottom: 16px;">
            <h3 style="margin:0; color:var(--text-white)">Compare CafÃ©s</h3>
            <div class="btn-icon" onclick="closeModal('screen-compare-select')"><i class="ph-bold ph-x"></i></div>
        </div>
        <p style="text-align:left; color:var(--text-muted); font-size:13px; margin-bottom:12px;">Select a spot to compare with current one.</p>
        <div class="compare-item-list" id="compare-list"></div>
    </div>
</div>

<div id="screen-compare-result" class="screen">
    <div class="btn-back" onclick="navTo('screen-detail')"><i class="ph-bold ph-arrow-left" style="font-size: 20px;"></i></div>
    <div class="col" style="padding: 60px 24px 20px;"><h1>Comparison</h1></div>
    <div class="scroll-view" style="padding: 0 24px;">
        <div class="compare-grid" style="margin-top: 20px; align-items: flex-start;">
            <div class="col center" style="gap: 10px;">
                <img id="cmp-img-1" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover;">
                <b id="cmp-title-1" style="font-size: 14px; color: var(--accent-cyan);"></b>
                <div class="col center" style="gap: 16px; margin-top: 10px;">
                    <div class="col center"><span class="cmp-label">WiFi</span><span id="cmp-wifi-1" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Drinks</span><span id="cmp-drinks-1" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Service</span><span id="cmp-service-1" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Price</span><span id="cmp-price-1" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Crowd</span><span id="cmp-crowd-1" style="font-size: 13px;"></span></div>
                </div>
            </div>
            <div class="compare-divider"></div>
            <div class="col center" style="gap: 10px;">
                <img id="cmp-img-2" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover;">
                <b id="cmp-title-2" style="font-size: 14px; color: var(--text-white);"></b>
                <div class="col center" style="gap: 16px; margin-top: 10px;">
                     <div class="col center"><span class="cmp-label">WiFi</span><span id="cmp-wifi-2" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Drinks</span><span id="cmp-drinks-2" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Service</span><span id="cmp-service-2" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Price</span><span id="cmp-price-2" style="font-size: 13px;"></span></div>
                    <div class="col center"><span class="cmp-label">Crowd</span><span id="cmp-crowd-2" style="font-size: 13px;"></span></div>
                </div>
            </div>
        </div>
        <div class="col" style="margin-top: 40px; gap: 12px;">
            <div class="row" style="gap: 10px;">
                <button id="btn-goto-a" class="btn btn-primary" style="flex:1; font-size: 12px;" onclick="navTo('screen-detail')">Go to this</button>
                <button id="btn-goto-b" class="btn btn-glass" style="flex:1; font-size: 12px;" onclick="goToCafeB()">Go to that</button>
            </div>
            <button class="btn btn-glass" style="width: 100%; border: 1px solid rgba(255,255,255,0.2);" onclick="navTo('screen-detail')">Return</button>
        </div>
    </div>
</div>

<!-- === BOTTOM NAV (GLOBAL) === -->
<div class="bottom-nav" id="main-nav">
    <div class="nav-icon active" onclick="navTo('screen-home')"><i class="ph-fill ph-house"></i>Home</div>
    <div class="nav-icon" onclick="navTo('screen-saved')"><i class="ph-fill ph-heart"></i>Saved</div>
    <div class="nav-icon" onclick="navTo('screen-account')"><i class="ph-fill ph-user"></i>Account</div>
    <div class="nav-icon" onclick="navTo('screen-activity')"><i class="ph-fill ph-bell"></i>Activity</div>
    <div class="nav-icon" onclick="navTo('screen-settings')"><i class="ph-fill ph-gear"></i>Setting</div>
</div>

<!-- === MODALS === -->
<div id="modal-login" class="modal-overlay">
    <div class="modal-card">
        <div class="col center">
            <div style="width: 60px; height: 60px; margin-bottom: 16px;"><i class="ph-fill ph-coffee" style="font-size: 30px; color: var(--accent-cyan);"></i></div>
            <h2 style="margin-bottom: 8px;">Welcome</h2>
            <p id="login-msg" class="mb-16" style="font-size: 13px; color: var(--text-muted);">Sign in to access features.</p>
        </div>
        <form onsubmit="loginUser(); return false;" novalidate>
            <input type="email" class="input-glass" placeholder="Email">
            <input type="password" class="input-glass" placeholder="Password">
            <button type="submit" class="btn btn-primary" style="width:100%; margin-bottom: 12px;">Sign In</button>
        </form>
        <div class="divider-text" style="color:var(--text-muted); font-size:12px; margin-bottom:10px;">or continue with</div>
        <div class="row center" style="gap: 20px; margin: 10px 0;">
            <button class="btn-icon" onclick="socialLogin('Google')"><i class="ph-fill ph-google-logo" style="font-size: 24px; color: #DB4437;"></i></button>
            <button class="btn-icon" onclick="socialLogin('Facebook')"><i class="ph-fill ph-facebook-logo" style="font-size: 24px; color: #4267B2;"></i></button>
            <button class="btn-icon" onclick="socialLogin('Apple')"><i class="ph-fill ph-apple-logo" style="font-size: 24px; color: var(--text-white);"></i></button>
        </div>
        <button class="btn btn-glass" style="width:100%; margin-top:8px;" onclick="closeModal('modal-login')">Cancel</button>
    </div>
</div>

<div id="modal-instruction" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 40px; margin-bottom: 10px;">ðŸŽ‰</div>
        <h3 style="margin-bottom: 10px;">Almost there!</h3>
        <p style="margin-bottom: 20px; line-height: 1.5; color: var(--text-muted);">Climb into the <b>Top 3 and above</b> to unlock even more cool places for you to explore! <3</p>
        <button class="btn btn-primary" style="width:100%;" onclick="closeModal('modal-instruction')">Sure!!</button>
    </div>
</div>

<div id="modal-unlock-congrats" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 40px; margin-bottom: 10px;">ðŸ”“</div>
        <h3 style="margin-bottom: 10px; color: var(--text-white);">Congrats!</h3>
        <p id="unlock-count-text" style="margin-bottom: 0; color: var(--text-muted);">You just unlocked 0 new cafes.</p>
        <div id="unlock-list" class="unlock-list"></div>
    </div>
</div>

<div id="modal-checkin-form" class="modal-overlay">
    <div class="modal-card" style="text-align: left;">
        <div class="checkin-header">
            <div class="checkin-title">Update Status</div>
            <div class="checkin-sub">Help the community & earn points!</div>
            <div class="checkin-bonus">Extra points for feedback (+20) and photo (+30).</div>
        </div>
        <div class="col mb-16"><label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Crowd Level</label><div class="input-bars" id="crowd-input-bars"></div><div class="row" style="justify-content: space-between; font-size: 10px; color: var(--text-muted);"><span>Empty</span><span>Full</span></div></div>
        <div class="col mb-16"><label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">WiFi Speed</label><select class="select-glass" id="input-wifi"><option>Excellent</option><option>Good</option><option>Okay</option><option>Bad</option></select></div>
        <div class="col mb-16"><label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Drinks</label><select class="select-glass" id="input-drinks"><option>Excellent</option><option>Good</option><option>Okay</option><option>Bad</option></select></div>
        <div class="col mb-16"><label style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">Your Feedback (optional)</label><textarea id="checkin-feedback" class="input-glass" style="height: 60px;" placeholder="We appreciate your advice â¤"></textarea></div>
        <div class="row" style="gap: 10px; margin-bottom: 20px;">
            <label class="btn btn-glass" style="flex:1; font-size: 12px; cursor: pointer;">
                <i class="ph ph-camera"></i> Picture upload
                <input type="file" id="checkin-file-input" accept="image/*" style="display: none;">
            </label>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="submitCheckInForm()">Submit Update</button>
        <button class="btn btn-glass" style="width:100%; margin-top:8px;" onclick="closeModal('modal-checkin-form')">Cancel</button>
    </div>
</div>

<div id="modal-xp" class="modal-overlay">
    <div class="modal-card" style="background: transparent; box-shadow: none; border: none; backdrop-filter: none;">
        <h1 id="xp-amount" style="font-size: 40px; color: var(--accent-cyan); text-shadow: 0 0 20px var(--accent-cyan);">+50 XP</h1>
        <p style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">Thanks for updating!</p>
    </div>
</div>

<div id="modal-rank" class="modal-overlay">
    <div class="modal-card" style="background: transparent; box-shadow: none; border: none; backdrop-filter: none;">
        <div style="font-size: 42px; margin-bottom: 6px;">ðŸ†</div>
        <h2 id="rank-amount" style="font-size: 28px; color: #fff; text-shadow: 0 0 24px rgba(225, 100, 90, 0.75);">Rank up!</h2>
        <p id="rank-sub" style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 6px;">You climbed the leaderboard.</p>
    </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox-overlay" id="lightbox">
    <div class="lightbox-close" onclick="closeLightbox()"><i class="ph-bold ph-x"></i></div>
    <!-- Arrows -->
    <div class="lightbox-nav-btn lightbox-prev" onclick="changeLightboxImage(-1)"><i class="ph-bold ph-caret-left"></i></div>
    <div class="lightbox-nav-btn lightbox-next" onclick="changeLightboxImage(1)"><i class="ph-bold ph-caret-right"></i></div>
    <!-- Image -->
    <img class="lightbox-img" id="lightbox-image" src="" onclick="event.stopPropagation()">
    <!-- Dots -->
    <div class="lightbox-dots" id="lightbox-dots"></div>
</div>
</div>
<script>
   
const cafes = [
// ---------- 1 ----------
{
id: 1,
title: "Cafe Hoa",
images: [
    "ASSETS/cafehoaspace1.png",
    "ASSETS/cafehoaspace2.png",
    "ASSETS/cafehoaspace3.png",
    "ASSETS/cafehoaspace4.png"
],
communityGallery: {
    place: [
        "ASSETS/cafehoaspace1.png",
        "ASSETS/cafehoaspace2.png",
        "ASSETS/cafehoaspace3.png",
        "ASSETS/cafehoaspace4.png",
        "ASSETS/cafehoaspace5.png",
        "ASSETS/cafehoaspace6.png"
    ],
    menu: [
        "ASSETS/cafehoamenu7.png"
    ],
    group: [
        "ASSETS/cafehoagroup1.png",
        "ASSETS/cafehoagroup2.png",
        "ASSETS/cafehoagroup3.png",
        "ASSETS/cafehoagroup4.png",
        "ASSETS/cafehoagroup5.png",
        "ASSETS/cafehoagroup6.png"
    ]
},
communityContributions: [ 
    { user: "Nhi", comment: "Quiet spot, great for reading.", photo: null, time: "10 min ago" }, 
    { user: "ThÆ°", comment: "Love the decor here!", photo: "ASSETS/cafehoaspace2.png", time: "2 hours ago" } 
],
openTime: "09:00", closeTime: "22:00",
map: "https://maps.app.goo.gl/k9PYi9iRDTXvPnLG7",
address: "414/17 CÃ¡ch Máº¡ng ThÃ¡ng TÃ¡m, Q.3",
hotline: "0868324845",
note: "The air-conditioning is a bit too cold, though the spot is a hidden gem and not widely known.",
isFavorite: false,
lat: 10.784050357081421, lng: 106.67120834061035, 

aiCrowdScore: 15,
    finalCrowdScore: 18,
    wifi: "Excellent",
    drinks: "Okay",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [5, 10, 15, 12, 8, 5],
        "Tue": [5, 12, 18, 15, 10, 5],
        "Wed": [8, 15, 20, 18, 12, 6],
        "Thu": [8, 15, 22, 18, 10, 8],
        "Fri": [10, 20, 25, 22, 15, 10],
        "Sat": [15, 25, 30, 25, 20, 12],
        "Sun": [15, 28, 35, 28, 18, 10]
    }
},

// ---------- 2 ----------
{ 
    id: 2,
    title: "Day In Cafe & Brunch",
    images: [
        "ASSETS/dayincafe&brunchspace1.png",
        "ASSETS/dayincafe&brunchspace2.png",
        "ASSETS/dayincafe&brunchspace3.png",
        "ASSETS/dayincafe&brunchspace4.png"
    ], 
    communityGallery: {
        place: [
            "ASSETS/dayincafe&brunchspace1.png",
            "ASSETS/dayincafe&brunchspace2.png",
            "ASSETS/dayincafe&brunchspace3.png",
            "ASSETS/dayincafe&brunchspace4.png"
        ],
        menu: [
            "ASSETS/dayincafe&brunchmenu1.png",
            "ASSETS/dayincafe&brunchmenu2.png",
            "ASSETS/dayincafe&brunchmenu3.png",
            "ASSETS/dayincafe&brunchmenu4.png",
            "ASSETS/dayincafe&brunchmenu5.png",
            "ASSETS/dayincafe&brunchmenu6.png",
            "ASSETS/dayincafe&brunchmenu7.png"
        ],
        group: [
            "ASSETS/dayincafe&brunchgroup1.png",
            "ASSETS/dayincafe&brunchgroup2.png",
            "ASSETS/dayincafe&brunchgroup3.png"
        ]
    },
    communityContributions: [{ user: "Chianti", comment: "Perfect background noise level for deep work.", photo: "ASSETS/dayincafe&brunchspace2.png", time: "20 min ago" }], 
    openTime: "07:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/1Dg9MmPkKxCgYKCt5",
    address: "TÃ´n Dáº­t TiÃªn, Khu Ä‘Ã´ thá»‹ PhÃº Má»¹ HÆ°ng, Q.7",
    hotline: "0904108896",
    note: "They do matcha really well here; it's what they're known for. Usually not crowded at all!",
    isFavorite: false,
    lat: 10.723057953057431, lng: 106.71576422944784, 
 
    aiCrowdScore: 25,
    finalCrowdScore: 23,
    wifi: "Excellent",
    drinks: "Excellent",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [10, 20, 25, 20, 15, 5],
        "Tue": [10, 22, 28, 22, 18, 8],
        "Wed": [12, 25, 30, 25, 20, 10],
        "Thu": [12, 25, 32, 28, 20, 10],
        "Fri": [15, 30, 40, 35, 25, 15],
        "Sat": [20, 45, 50, 40, 30, 20],
        "Sun": [25, 50, 55, 45, 35, 20]
    }
},

// ---------- 3 ----------
{ 
    id: 3,
    title: "OKKIO Cafe â€“ Duy TÃ¢n",
    images: [
        "ASSETS/okkiocafeduytanspace1.png",
        "ASSETS/okkiocafeduytanspace2.png",
        "ASSETS/okkiocafeduytanspace3.png",
        "ASSETS/okkiocafeduytanspace4.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/okkiocafeduytanspace1.png",
            "ASSETS/okkiocafeduytanspace2.png",
            "ASSETS/okkiocafeduytanspace3.png",
            "ASSETS/okkiocafeduytanspace4.png"
        ],
        menu: [
            "ASSETS/okkiocafeduytanmenu1.png",
            "ASSETS/okkiocafeduytanmenu2.png",
            "ASSETS/okkiocafeduytanmenu3.png",
            "ASSETS/okkiocafeduytanmenu4.png"
        ],
        group: [
            "ASSETS/okkiocafeduytangroup1.png",
            "ASSETS/okkiocafeduytangroup2.png",
            "ASSETS/okkiocafeduytangroup3.png",
            "ASSETS/okkiocafeduytangroup4.png",
            "ASSETS/okkiocafeduytangroup5.png",
            "ASSETS/okkiocafeduytangroup6.png"
        ]
    },
    communityContributions: [{ user: "Há»§", comment: "Love the outdoor seating area.", photo: "ASSETS/okkiocafeduytanspace2.png", time: "15 min ago" }],
    openTime: "07:30", closeTime: "22:00",
    map: "https://maps.app.goo.gl/1KXZT6mUB9svuSnu5",
    address: "41/1 Pháº¡m Ngá»c Tháº¡ch, P.6, Q.3",
    hotline: "0899188286",
    note: "It's a little pricey, but totally worth it for studying and having a nice drink.",
    isFavorite: false,
    lat: 10.784553710961607, lng: 106.69324798834312,  

    aiCrowdScore: 65,
    finalCrowdScore: 68,
    wifi: "Excellent",
    drinks: "Excellent",
    service: "Excellent",
    price: "$$$",
    crowdDataset: {
        "Mon": [30, 50, 60, 55, 40, 20],
        "Tue": [35, 55, 65, 58, 45, 25],
        "Wed": [35, 60, 70, 60, 50, 30],
        "Thu": [40, 65, 75, 65, 55, 35],
        "Fri": [45, 75, 85, 80, 70, 50],
        "Sat": [50, 85, 95, 90, 80, 60],
        "Sun": [55, 90, 92, 85, 75, 55]
    }
},

// ---------- 4 ----------
{ 
    id: 4,
    title: "Little HaNoi Egg Coffee",
    images: [
        "ASSETS/littlehanoieggcoffekyconspace1.png",
        "ASSETS/littlehanoieggcoffekyconspace2.png",
        "ASSETS/littlehanoieggcoffekyconspace3.png",
        "ASSETS/littlehanoieggcoffekyconspace4.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/littlehanoieggcoffekyconspace1.png",
            "ASSETS/littlehanoieggcoffekyconspace2.png",
            "ASSETS/littlehanoieggcoffekyconspace3.png",
            "ASSETS/littlehanoieggcoffekyconspace4.png"
        ],
        menu: [
            "ASSETS/littlehanoieggcoffekyconmenu1.png",
            "ASSETS/littlehanoieggcoffekyconmenu2.png",
            "ASSETS/littlehanoieggcoffekyconmenu3.png",
            "ASSETS/littlehanoieggcoffekyconmenu4.png",
            "ASSETS/littlehanoieggcoffekyconmenu5.png",
            "ASSETS/littlehanoieggcoffekyconmenu6.png",
            "ASSETS/littlehanoieggcoffekyconmenu7.png",
            "ASSETS/littlehanoieggcoffekyconmenu8.png",
            "ASSETS/littlehanoieggcoffekyconmenu9.png",
            "ASSETS/littlehanoieggcoffekyconmenu10.png",
            "ASSETS/littlehanoieggcoffekyconmenu11.png",
            "ASSETS/littlehanoieggcoffekyconmenu12.png"
        ],
        group: [
            "ASSETS/littlehanoieggcoffekycongroup1.png",
            "ASSETS/littlehanoieggcoffekycongroup2.png",
            "ASSETS/littlehanoieggcoffekycongroup3.png",
            "ASSETS/littlehanoieggcoffekycongroup4.png"
        ]
    },
    communityContributions: [{ user: "ÄÃ´ng", comment: "The egg coffee custard is incredibly rich and creamy, perfect for dipping the crispy toast. A must-try!", photo: "ASSETS/littlehanoieggcoffekyconspace2.png", time: "35 min ago" }],
    openTime: "07:00", closeTime: "21:30",
    map: "https://maps.app.goo.gl/zUzuYqJYPWwJqBCz7",
    address: "167 KÃ½ Con, P.Nguyá»…n ThÃ¡i BÃ¬nh, Q.1",
    hotline: "0904522339",
    note: "It's a little pricey, but totally worth it for studying and having a nice drink.",
    isFavorite: false,
    lat: 10.768431280397227, lng: 106.69722337597861, 

    aiCrowdScore: 55,
    finalCrowdScore: 53,
    wifi: "Good",
    drinks: "Excellent",
    service: "Excellent",
    price: "$$$",
    crowdDataset: {
        "Mon": [20, 40, 50, 45, 35, 15],
        "Tue": [25, 45, 55, 48, 38, 18],
        "Wed": [25, 50, 60, 50, 40, 20],
        "Thu": [30, 55, 65, 55, 45, 25],
        "Fri": [35, 65, 75, 70, 60, 40],
        "Sat": [40, 80, 85, 80, 70, 50],
        "Sun": [45, 85, 88, 80, 65, 45]
    }
},

// ---------- 5 ----------
{ 
    id: 5,
    title: "Chá»‘n RiÃªng (Quáº­n 10)",
    images: [
        "ASSETS/chonriengquan10space1.png",
        "ASSETS/chonriengquan10space2.png",
        "ASSETS/chonriengquan10space3.png",
        "ASSETS/chonriengquan10space4.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/chonriengquan10space1.png",
            "ASSETS/chonriengquan10space2.png",
            "ASSETS/chonriengquan10space3.png",
            "ASSETS/chonriengquan10space4.png",
            "ASSETS/chonriengquan10space5.png"
        ],
        menu: [
            "ASSETS/chonriengquan10menu1.png",
            "ASSETS/chonriengquan10menu2.png",
            "ASSETS/chonriengquan10menu3.png"
        ],
        group: [
            "ASSETS/chonriengquan10group1.png",
            "ASSETS/chonriengquan10group2.png",
            "ASSETS/chonriengquan10group3.png",
            "ASSETS/chonriengquan10group4.png"
        ]
    },
    communityContributions: [
        { user: "Táº§n", comment: "Perfect background noise level for deep work.", photo: "ASSETS/chonriengquan10space2.png", time: "5 min ago" }
    ],
    openTime: "00:00",
    closeTime: "23:59",
    map: "https://maps.app.goo.gl/dxBEKBpodEeTGg4z9",
    address: "156/7e/9, TÃ´ Hiáº¿n ThÃ nh, P.15, Q.10",
    hotline: "0363456371",
    note: "Itâ€™s very cheap since they only use instant beverages, but the study space is great. Only 25k per person for 4 hours.",
    isFavorite: false,
    lat: 10.781510041285694, lng: 106.6678081177877, 

    aiCrowdScore: 78,
    finalCrowdScore: 79,
    wifi: "Excellent",
    drinks: "Okay",
    service: "Good",
    price: "$",

    crowdDataset: {
        "Mon": [40, 60, 85, 80, 60, 35],
        "Tue": [35, 58, 80, 78, 55, 30],
        "Wed": [38, 62, 88, 82, 60, 32],
        "Thu": [40, 65, 90, 85, 65, 35],
        "Fri": [45, 75, 95, 92, 80, 60],
        "Sat": [55, 85, 98, 95, 88, 70],
        "Sun": [50, 80, 90, 85, 70, 45]
    }
},


// ---------- 6 ----------
{ 
    id: 6,
    title: "Báº¢N CÃ  PhÃª (Quáº­n 1)",
    images: [
        "ASSETS/bancaphequan1space1.png",
        "ASSETS/bancaphequan1space2.png",
        "ASSETS/bancaphequan1space3.png",
        "ASSETS/bancaphequan1space4.png",
        "ASSETS/bancaphequan1space5.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/bancaphequan1space1.png",
            "ASSETS/bancaphequan1space2.png",
            "ASSETS/bancaphequan1space3.png",
            "ASSETS/bancaphequan1space4.png",
            "ASSETS/bancaphequan1space5.png",
            "ASSETS/bancaphequan1space6.png",
            "ASSETS/bancaphequan1space7.png",
            "ASSETS/bancaphequan1space8.png",
            "ASSETS/bancaphequan1space9.png"
        ],
        menu: [
            "ASSETS/bancaphequan1menu1.png",
            "ASSETS/bancaphequan1menu2.png",
            "ASSETS/bancaphequan1menu3.png",
            "ASSETS/bancaphequan1menu4.png",
            "ASSETS/bancaphequan1menu5.png",
            "ASSETS/bancaphequan1menu6.png",
            "ASSETS/bancaphequan1menu7.png",
            "ASSETS/bancaphequan1menu8.png",
            "ASSETS/bancaphequan1menu9.png"
        ],
        group: ["ASSETS/bancaphequan1group1.png"]
    },
    communityContributions: [
         { user: "Hy Táº§n", comment: "Quiet spot, great for reading.", photo: null, time: "10 min ago" },
         { user: "Mai Trang", comment: "Love the decor here!", photo: "ASSETS/bancaphequan1space2.png", time: "2 hours ago" }
    ],
    openTime: "08:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/4yL8pkiYdN11V3eN8",
    address: "38/7 LÃª Lá»£i, Báº¿n NghÃ©, Q.1",
    hotline: "02866726936",
    note: "A small, cozy, calm vibe, perfect for focusing on deadlines.",
    isFavorite: false,
    lat: 10.774096569854493, lng: 106.70032729999916, 

    aiCrowdScore: 35,
    finalCrowdScore: 29,
    wifi: "Excellent",
    drinks: "Good",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [15, 25, 35, 30, 20, 10],
        "Tue": [15, 30, 38, 32, 22, 12],
        "Wed": [20, 35, 40, 35, 25, 15],
        "Thu": [20, 38, 45, 38, 28, 18],
        "Fri": [25, 45, 55, 50, 40, 25],
        "Sat": [30, 55, 65, 60, 45, 30],
        "Sun": [35, 60, 68, 55, 40, 25]
    }
},

// ---------- 7 ----------
{ 
    id: 7,
    title: "Unihub Coffee (Quáº­n 3)",
    images: [
        "ASSETS/unihubcoffeequan3space1.png",
        "ASSETS/unihubcoffeequan3space2.png",
        "ASSETS/unihubcoffeequan3space3.png",
        "ASSETS/unihubcoffeequan3space4.png",
        "ASSETS/unihubcoffeequan3space5.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/unihubcoffeequan3space1.png",
            "ASSETS/unihubcoffeequan3space2.png",
            "ASSETS/unihubcoffeequan3space3.png",
            "ASSETS/unihubcoffeequan3space4.png",
            "ASSETS/unihubcoffeequan3space5.png",
            "ASSETS/unihubcoffeequan3space6.png",
            "ASSETS/unihubcoffeequan3space7.png"
        ],
        menu: [
            "ASSETS/unihubcoffeequan3menu1.png",
            "ASSETS/unihubcoffeequan3menu2.png",
            "ASSETS/unihubcoffeequan3menu3.png",
            "ASSETS/unihubcoffeequan3menu4.png",
            "ASSETS/unihubcoffeequan3menu5.png",
            "ASSETS/unihubcoffeequan3menu6.png",
            "ASSETS/unihubcoffeequan3menu7.png",
            "ASSETS/unihubcoffeequan3menu8.png",
            "ASSETS/unihubcoffeequan3menu9.png"
        ],
        group: [
            "ASSETS/unihubcoffeequan3group1.png",
            "ASSETS/unihubcoffeequan3group2.png",
            "ASSETS/unihubcoffeequan3group3.png",
            "ASSETS/unihubcoffeequan3group4.png",
            "ASSETS/unihubcoffeequan3group5.png",
            "ASSETS/unihubcoffeequan3group6.png",
            "ASSETS/unihubcoffeequan3group7.png"
        ]
    },
    communityContributions: [{ user: "Jade", comment: "The Matcha Latte is a must-try.", photo: "ASSETS/unihubcoffeequan3space2.png", time: "5 min ago" }],
    openTime: "07:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/Yhn45UrKtD9iw66X9",
    address: "130 Nguyá»…n Thá»‹ Minh Khai, P.VÃµ Thá»‹ SÃ¡u, Q.3",
    hotline: "0343090763",
    note: "They also serve main dishes like bÃ² kho and rice, great for long hours of study.",
    isFavorite: false,
    lat: 10.777333785265673, lng: 106.69266756810208, 

    aiCrowdScore: 68,
    finalCrowdScore: 61,
    wifi: "Excellent",
    drinks: "Excellent",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [30, 70, 60, 55, 65, 30],
        "Tue": [35, 75, 65, 60, 70, 35],
        "Wed": [35, 78, 68, 65, 72, 40],
        "Thu": [40, 80, 70, 68, 75, 45],
        "Fri": [45, 85, 75, 75, 85, 55],
        "Sat": [50, 90, 80, 80, 90, 60],
        "Sun": [55, 85, 85, 75, 80, 50]
    }
},

// ---------- 8 ----------
{ 
    id: 8,
    title: "ISPACE Coffee & Time",
    images: [
        "ASSETS/ispacecoffee&timespace1.png",
        "ASSETS/ispacecoffee&timespace2.png",
        "ASSETS/ispacecoffee&timespace3.png",
        "ASSETS/ispacecoffee&timespace4.png",
        "ASSETS/ispacecoffee&timespace5.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/ispacecoffee&timespace1.png",
            "ASSETS/ispacecoffee&timespace2.png",
            "ASSETS/ispacecoffee&timespace3.png",
            "ASSETS/ispacecoffee&timespace4.png",
            "ASSETS/ispacecoffee&timespace5.png",
            "ASSETS/ispacecoffee&timespace6.png",
            "ASSETS/ispacecoffee&timespace7.png",
            "ASSETS/ispacecoffee&timespace8.png",
            "ASSETS/ispacecoffee&timespace9.png",
            "ASSETS/ispacecoffee&timespace10.png"
        ],
        menu: [
            "ASSETS/ispacecoffee&timemenu1.png",
            "ASSETS/ispacecoffee&timemenu2.png",
            "ASSETS/ispacecoffee&timemenu3.png",
            "ASSETS/ispacecoffee&timemenu4.png",
            "ASSETS/ispacecoffee&timemenu5.png"
        ],
        group: [
            "ASSETS/ispacecoffee&timegroup1.png",
            "ASSETS/ispacecoffee&timegroup2.png",
            "ASSETS/ispacecoffee&timegroup3.png",
            "ASSETS/ispacecoffee&timegroup4.png",
            "ASSETS/ispacecoffee&timegroup5.png",
            "ASSETS/ispacecoffee&timegroup6.png"
        ]
    },
    communityContributions: [{ user: "Huy", comment: "Fast Wifi and plenty of power outlets. A lifesaver!", photo: "ASSETS/ispacecoffee&timespace2.png", time: "45 min ago" }],
    openTime: "06:30", closeTime: "04:00",
    map: "https://maps.app.goo.gl/TWhbxcsvCGNGzBJK8",
    address: "204 ÄÆ°á»ng sá»‘ 20, P.5, GÃ² Váº¥p",
    hotline: "0969273881",
    note: "This place has both meeting rooms and nap rooms, and the stir-fried noodles are surprisingly tasty.",
    isFavorite: false,
    lat: 10.8366327882386, lng: 106.68945529527393,

    aiCrowdScore: 50,
    finalCrowdScore: 50,
    wifi: "Excellent",
    drinks: "Okay",
    service: "Good",
    price: "$",
    crowdDataset: {
        "Mon": [25, 45, 55, 50, 40, 45],
        "Tue": [25, 50, 60, 55, 45, 50],
        "Wed": [30, 55, 65, 60, 50, 55],
        "Thu": [30, 60, 70, 65, 55, 60],
        "Fri": [35, 65, 75, 70, 65, 70],
        "Sat": [40, 70, 80, 75, 70, 75],
        "Sun": [40, 75, 85, 70, 60, 65]
    }
},

// ---------- 9 ----------
{ 
    id: 9,
    title: "Lelaz Coffee â€“ Tea House",
    images: [
        "ASSETS/lelazcoffeetrasuavacaphespace1.png",
        "ASSETS/lelazcoffeetrasuavacaphespace2.png",
        "ASSETS/lelazcoffeetrasuavacaphespace3.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/lelazcoffeetrasuavacaphespace1.png",
            "ASSETS/lelazcoffeetrasuavacaphespace2.png",
            "ASSETS/lelazcoffeetrasuavacaphespace3.png"
        ],
        menu: [
            "ASSETS/lelazcoffeetrasuavacaphemenu1.png",
            "ASSETS/lelazcoffeetrasuavacaphemenu2.png",
            "ASSETS/lelazcoffeetrasuavacaphemenu3.png",
            "ASSETS/lelazcoffeetrasuavacaphemenu4.png"
        ],
        group: [
            "ASSETS/lelazcoffeetrasuavacaphegroup1.png",
            "ASSETS/lelazcoffeetrasuavacaphegroup2.png",
            "ASSETS/lelazcoffeetrasuavacaphegroup3.png"
        ]
    },
    communityContributions: [
        { user: "Minh ThÆ°", comment: "Good value for money.", photo: "ASSETS/lelazcoffeetrasuavacaphespace2.png", time: "15 min ago" },
        { user: "Uni", comment: "Friendly service, will definitely come back.", photo: "ASSETS/lelazcoffeetrasuavacaphespace3.png", time: "2 hours ago" }
    ],
    openTime: "08:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/5fhGc4mtEgtywKfUA",
    address: "93b Ä. Háº­u Giang, P.5, Q.6",
    hotline: "0333951584",
    note: "Study-friendly vibe with no notable decorations. Large tables, comfortable for working.",
    isFavorite: false,
    lat: 10.749466298507212, lng: 106.64685878034399, 

    aiCrowdScore: 58,
    finalCrowdScore: 55,
    wifi: "Excellent",
    drinks: "Bad",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [20, 50, 65, 55, 40, 20],
        "Tue": [25, 55, 70, 60, 45, 25],
        "Wed": [25, 60, 72, 65, 50, 30],
        "Thu": [30, 65, 75, 70, 55, 35],
        "Fri": [35, 70, 80, 75, 65, 45],
        "Sat": [40, 80, 85, 80, 70, 50],
        "Sun": [45, 85, 88, 75, 60, 40]
    }
},

// ---------- 10 ----------
{ 
    id: 10,
    title: "Hay LÃ  Cafe",
    images: [
        "ASSETS/haylacafespace1.png",
        "ASSETS/haylacafespace2.png",
        "ASSETS/haylacafespace3.png",
        "ASSETS/haylacafespace4.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/haylacafespace1.png",
            "ASSETS/haylacafespace2.png",
            "ASSETS/haylacafespace3.png",
            "ASSETS/haylacafespace4.png",
            "ASSETS/haylacafespace5.png",
            "ASSETS/haylacafespace6.png"
        ],
        menu: [
            "ASSETS/haylacafemenu1.png",
            "ASSETS/haylacafemenu2.png",
            "ASSETS/haylacafemenu3.png",
            "ASSETS/haylacafemenu4.png"
        ],
        group: [
            "ASSETS/haylacafegroup1.png",
            "ASSETS/haylacafegroup2.png",
            "ASSETS/haylacafegroup3.png"
        ]
    },
    communityContributions: [
        { user: "Soya", comment: "Good value for money.", photo: "ASSETS/haylacafespace2.png", time: "15 min ago" },
        { user: "NaBbi", comment: "They have an adorable resident cat here! ðŸˆ", photo: "ASSETS/haylacafespace3.png", time: "20 min ago" },
        { user: "Tbn", comment: "The signature foam drinks are amazing! Loved the one with crushed nuts on top, so creamy and nutty.", photo: "ASSETS/haylacafespace4.png", time: "45 min ago" },

    ],
    openTime: "08:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/rLNfdi3waB6qc8Zu5",
    address: "497/11 SÆ° Váº¡n Háº¡nh, P.12, Q.10",
    hotline: "0931149507",
    note: "Small but cozy, simple, and pleasantly comfortable.",
    isFavorite: false,
    lat: 10.7739233524, lng: 106.667917129, 

    aiCrowdScore: 42,
    finalCrowdScore: 45,
    wifi: "Good",
    drinks: "Excellent",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [15, 35, 45, 40, 30, 15],
        "Tue": [18, 40, 50, 42, 35, 18],
        "Wed": [20, 45, 55, 45, 38, 20],
        "Thu": [22, 48, 58, 48, 40, 22],
        "Fri": [25, 55, 65, 60, 50, 30],
        "Sat": [30, 70, 75, 65, 55, 40],
        "Sun": [35, 75, 80, 60, 45, 30]
    }
},

// ---------- 11 ----------
{ 
    id: 11,
    title: "ThÃ nh Coffee",
    images: [
        "ASSETS/thanhcoffeespace1.png",
        "ASSETS/thanhcoffeespace2.png",
        "ASSETS/thanhcoffeespace3.png",
        "ASSETS/thanhcoffeespace4.png",
        "ASSETS/thanhcoffeespace5.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/thanhcoffeespace1.png",
            "ASSETS/thanhcoffeespace2.png",
            "ASSETS/thanhcoffeespace3.png",
            "ASSETS/thanhcoffeespace4.png",
            "ASSETS/thanhcoffeespace5.png"
        ],
        menu: [
            "ASSETS/thanhcoffeemenu1.jpg",
            "ASSETS/thanhcoffeemenu2.jpg",
            "ASSETS/thanhcoffeemenu3.jpg",
            "ASSETS/thanhcoffeemenu4.jpg",
            "ASSETS/thanhcoffeemenu5.jpg",
            "ASSETS/thanhcoffeemenu6.jpg",
            "ASSETS/thanhcoffeemenu7.jpg"
        ],
        group: ["ASSETS/thanhcoffeegroup1.png"]
    },
    communityContributions: [
        { user: "AndZ", comment: "Good flavor, though slightly too sweet for me.", photo: "ASSETS/thanhcoffeespace2.png", time: "10 min ago" },
    ],
    openTime: "07:00", closeTime: "00:00",
    map: "https://maps.app.goo.gl/WTvFcq3SuK8aECy48",
    address: "1 Ä. NhiÃªu Tá»©, P.7, PhÃº Nhuáº­n",
    hotline: "0396803459",
    note: "Lovely, super quiet space with cute decorations. Great for working and taking photos.",
    isFavorite: false,
    lat: 10.801994723989024, lng: 106.68934655583686, 

    aiCrowdScore: 28,
    finalCrowdScore: 25,
    wifi: "Excellent",
    drinks: "Okay",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [10, 20, 30, 25, 15, 10],
        "Tue": [12, 25, 35, 28, 18, 12],
        "Wed": [15, 28, 38, 30, 20, 15],
        "Thu": [15, 30, 40, 35, 22, 18],
        "Fri": [20, 40, 50, 45, 35, 25],
        "Sat": [25, 55, 60, 50, 40, 30],
        "Sun": [30, 60, 65, 45, 35, 20]
    }
},

// ---------- 12 ----------
{ 
    id: 12,
    title: "CÃ  Rá» Cafe",
    images: [
        "ASSETS/carecafespace1.png",
        "ASSETS/carecafespace2.png",
        "ASSETS/carecafespace3.png",
        "ASSETS/carecafespace4.png",
        "ASSETS/carecafespace5.png",
        "ASSETS/carecafespace6.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/carecafespace1.png",
            "ASSETS/carecafespace2.png",
            "ASSETS/carecafespace3.png",
            "ASSETS/carecafespace4.png",
            "ASSETS/carecafespace5.png",
            "ASSETS/carecafespace6.png"
        ],
        menu: [
            "ASSETS/carecafemenu1.jpg",
            "ASSETS/carecafemenu2.jpg",
            "ASSETS/carecafemenu3.jpg",
            "ASSETS/carecafemenu4.jpg",
            "ASSETS/carecafemenu5.jpg",
            "ASSETS/carecafemenu6.png",
            "ASSETS/carecafemenu7.png",
            "ASSETS/carecafemenu8.jpg",
            "ASSETS/carecafemenu9.jpg",
            "ASSETS/carecafemenu10.jpg"
        ],
        group: ["ASSETS/carecafegroup1.png"]
    },
    communityContributions: [
        { user: "Kim NgÃ¢n", comment: "Quiet spot, great for studying.", photo: "ASSETS/carecafespace2.png", time: "15 min ago" }
    ],
    openTime: "08:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/z8YxiDzkYfGhk2hWA",
    address: "Chung cÆ°, 35 Nguyá»…n VÄƒn TrÃ¡ng, P.Pháº¡m NgÅ© LÃ£o, Q.1",
    hotline: "0886161380",
    note: "The matcha here is outstanding, though it can get crowded during peak hours.",
    isFavorite: false,
    lat: 10.770666352435487, lng: 106.69170010000053, 

    aiCrowdScore: 85,
    finalCrowdScore: 83,
    wifi: "Excellent",
    drinks: "Excellent",
    service: "Excellent",
    price: "$$",
    crowdDataset: {
        "Mon": [40, 70, 80, 75, 60, 30],
        "Tue": [45, 75, 85, 78, 65, 35],
        "Wed": [45, 78, 88, 80, 70, 40],
        "Thu": [50, 80, 90, 85, 75, 45],
        "Fri": [55, 85, 95, 90, 85, 60],
        "Sat": [60, 95, 100, 95, 90, 70],
        "Sun": [65, 98, 95, 90, 80, 50]
    }
},

// ---------- 13 ----------
{ 
    id: 13,
    title: "TÃ¡ch TÃ¡ch Cafe",
    images: [
        "ASSETS/tachtachcafenguyenvatrangspace1.png",
        "ASSETS/tachtachcafenguyenvatrangspace2.png",
        "ASSETS/tachtachcafenguyenvatrangspace4.png",
        "ASSETS/tachtachcafenguyenvatrangspace5.png",
        "ASSETS/tachtachcafenguyenvatrangspace6.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/tachtachcafenguyenvatrangspace1.png",
            "ASSETS/tachtachcafenguyenvatrangspace2.png",
            "ASSETS/tachtachcafenguyenvatrangspace4.png",
            "ASSETS/tachtachcafenguyenvatrangspace5.png",
            "ASSETS/tachtachcafenguyenvatrangspace6.png"
        ],
        menu: [
            "ASSETS/tachtachcafenguyenvatrangmenu1.png",
            "ASSETS/tachtachcafenguyenvatrangmenu2.png",
            "ASSETS/tachtachcafenguyenvatrangmenu3.png",
            "ASSETS/tachtachcafenguyenvatrangmenu4.png",
            "ASSETS/tachtachcafenguyenvatrangmenu5.png"
        ],
        group: ["ASSETS/tachtachcafenguyenvatranggroup1.png"]
    },
    communityContributions: [{ user: "Jack", comment: "Nice place.", photo: null, time: "55 min ago" }],
    openTime: "08:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/jcijp9bEn7umRo7W6",
    address: "Chung cÆ°, 35 Nguyá»…n VÄƒn TrÃ¡ng, P.Pháº¡m NgÅ© LÃ£o, Q.1",
    hotline: "0817592627",
    note: "The music playlist is soothing and perfect for work. Gentle essential-oil scent.",
    isFavorite: false,
    lat: 10.770678209740407, lng: 106.69171954601433, 

    aiCrowdScore: 45,
    finalCrowdScore: 47,
    wifi: "Good",
    drinks: "Good",
    service: "Excellent",
    price: "$$",
    crowdDataset: {
        "Mon": [20, 40, 50, 45, 30, 15],
        "Tue": [20, 45, 55, 48, 35, 18],
        "Wed": [25, 48, 58, 50, 38, 20],
        "Thu": [25, 50, 60, 55, 40, 22],
        "Fri": [30, 60, 70, 65, 50, 30],
        "Sat": [35, 70, 80, 70, 60, 40],
        "Sun": [40, 75, 85, 65, 50, 30]
    }
},

// ---------- 14 ----------
{ 
    id: 14,
    title: "THE WISELANDS Coffee",
    images: [
        "ASSETS/thewiselandscoffeespace1.png",
        "ASSETS/thewiselandscoffeespace2.png",
        "ASSETS/thewiselandscoffeespace3.png",
        "ASSETS/thewiselandscoffeespace4.png",
        "ASSETS/thewiselandscoffeespace5.png",
        "ASSETS/thewiselandscoffeespace6.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/thewiselandscoffeespace1.png",
            "ASSETS/thewiselandscoffeespace2.png",
            "ASSETS/thewiselandscoffeespace3.png",
            "ASSETS/thewiselandscoffeespace4.png",
            "ASSETS/thewiselandscoffeespace5.png",
            "ASSETS/thewiselandscoffeespace6.png"
        ],
        menu: [
            "ASSETS/thewiselandscoffeemenu1.png",
            "ASSETS/thewiselandscoffeemenu2.png",
            "ASSETS/thewiselandscoffeemenu3.png",
            "ASSETS/thewiselandscoffeemenu4.png",
            "ASSETS/thewiselandscoffeemenu5.png"
        ],
        group: ["ASSETS/thewiselandscoffeegroup1.png"]
    },
    communityContributions: [{ user: "Nháº¡n", comment: "Beautiful view from the balcony.", photo: null, time: "25 min ago" }],
    openTime: "07:00", closeTime: "23:00",
    map: "https://maps.app.goo.gl/1Hiue5NiwXwtQaXW8",
    address: "216 Äiá»‡n BiÃªn Phá»§, P.VÃµ Thá»‹ SÃ¡u, Q.3",
    hotline: "0334626989",
    note: "Super spacious; great for deadlines or group discussions.",
    isFavorite: false,
    lat: 10.782997412878819, lng: 106.68985385337301, 

    aiCrowdScore: 62,
    finalCrowdScore: 57,
    wifi: "Excellent",
    drinks: "Excellent",
    service: "Good",
    price: "$$$",
    crowdDataset: {
        "Mon": [25, 55, 65, 60, 40, 20],
        "Tue": [30, 60, 70, 65, 45, 25],
        "Wed": [30, 65, 72, 68, 50, 30],
        "Thu": [35, 68, 75, 70, 55, 35],
        "Fri": [40, 75, 85, 80, 65, 45],
        "Sat": [45, 85, 90, 85, 75, 50],
        "Sun": [50, 80, 85, 75, 60, 40]
    }
},

// ---------- 15 ----------
{ 
    id: 15,
    title: "The Workstation Coffee",
    images: [
        "ASSETS/theworkstationcoffeespace1.png",
        "ASSETS/theworkstationcoffeespace2.png",
        "ASSETS/theworkstationcoffeespace3.png",
        "ASSETS/theworkstationcoffeespace4.png",
        "ASSETS/theworkstationcoffeespace5.png",
        "ASSETS/theworkstationcoffeespace6.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/theworkstationcoffeespace1.png",
            "ASSETS/theworkstationcoffeespace2.png",
            "ASSETS/theworkstationcoffeespace3.png",
            "ASSETS/theworkstationcoffeespace4.png",
            "ASSETS/theworkstationcoffeespace5.png",
            "ASSETS/theworkstationcoffeespace6.png"
        ],
        menu: [
            "ASSETS/theworkstationcoffeemenu1.png",
            "ASSETS/theworkstationcoffeemenu2.png",
            "ASSETS/theworkstationcoffeemenu3.png",
            "ASSETS/theworkstationcoffeemenu4.png",
            "ASSETS/theworkstationcoffeemenu5.png"
        ],
        group: ["ASSETS/theworkstationcoffeegroup1.png"]
    },
    communityContributions: [{ user: "Alma", comment: "Great music playlist, very chill.", photo: "ASSETS/theworkstationcoffeespace2.png", time: "35 min ago" }],
    openTime: "07:00", closeTime: "00:00",
    map: "https://maps.app.goo.gl/JPLbkPxqzyPEwGHG6",
    address: "449 Äiá»‡n BiÃªn Phá»§, P.25, BÃ¬nh Tháº¡nh",
    hotline: "0909586449",
    note: "Enjoy 30% off the second drink after 3 hours. Up to 4â€“5 floors.",
    isFavorite: false,
    lat: 10.801718703145836, lng: 106.71352921057823, 

    aiCrowdScore: 75,
    finalCrowdScore: 65,
    wifi: "Excellent",
    drinks: "Good",
    service: "Excellent",
    price: "$$",
    crowdDataset: {
        "Mon": [30, 65, 80, 70, 50, 25],
        "Tue": [35, 70, 85, 75, 55, 30],
        "Wed": [35, 75, 88, 78, 60, 35],
        "Thu": [40, 78, 90, 80, 65, 40],
        "Fri": [45, 85, 95, 90, 75, 50],
        "Sat": [50, 90, 98, 92, 80, 60],
        "Sun": [55, 85, 90, 80, 70, 40]
    }
},

// ---------- 16 ----------
{ 
    id: 16,
    title: "Ellie â€“ QuÃ¡n cÃ  phÃª lá»—i thá»i",
    images: [
        "ASSETS/elliequancapheloithoispace1.png",
        "ASSETS/elliequancapheloithoispace2.png",
        "ASSETS/elliequancapheloithoispace3.png",
        "ASSETS/elliequancapheloithoispace4.png",
        "ASSETS/elliequancapheloithoispace5.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/elliequancapheloithoispace1.png",
            "ASSETS/elliequancapheloithoispace2.png",
            "ASSETS/elliequancapheloithoispace3.png",
            "ASSETS/elliequancapheloithoispace4.png",
            "ASSETS/elliequancapheloithoispace5.png"
        ],
        menu: [
            "ASSETS/elliequancapheloithoimenu1.png",
            "ASSETS/elliequancapheloithoimenu2.png",
            "ASSETS/elliequancapheloithoimenu3.png",
            "ASSETS/elliequancapheloithoimenu4.png"
        ],
        group: ["ASSETS/elliequancapheloithoigroup1.png"]
    },
    communityContributions: [{ user: "Tom", comment: "Such a cozy hidden gem.", photo: "ASSETS/elliequancapheloithoispace4.png", time: "1 hour ago" }],
    openTime: "08:30", closeTime: "21:30",
    map: "https://maps.app.goo.gl/WTzupihtfdAgPhxv6",
    address: "14 Äáº·ng Dung, P.TÃ¢n Äá»‹nh, Q.1",
    hotline: "None",
    note: "The place gets crowded quickly, and they offer 20% off the second beverage.",
    isFavorite: false,
    lat: 10.792824374511953, lng: 106.69108688773167, 

    aiCrowdScore: 88,
    finalCrowdScore: 85,
    wifi: "Excellent",
    drinks: "Excellent",
    service: "Excellent",
    price: "$$",
    crowdDataset: {
        "Mon": [45, 75, 85, 80, 60, 30],
        "Tue": [45, 80, 90, 85, 65, 35],
        "Wed": [50, 82, 92, 88, 70, 40],
        "Thu": [55, 85, 95, 90, 75, 45],
        "Fri": [60, 90, 98, 95, 85, 60],
        "Sat": [65, 95, 100, 98, 90, 70],
        "Sun": [70, 100, 95, 90, 80, 50]
    }
},

// ---------- 17 ----------
{ 
    id: 17,
    title: "Stomy's Coffee",
    images: [
        "ASSETS/stomyscoffeengotattospace1.png",
        "ASSETS/stomyscoffeengotattospace2.png",
        "ASSETS/stomyscoffeengotattospace3.png",
        "ASSETS/stomyscoffeengotattospace4.png",
        "ASSETS/stomyscoffeengotattospace5.png",
        "ASSETS/stomyscoffeengotattospace6.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/stomyscoffeengotattospace1.png",
            "ASSETS/stomyscoffeengotattospace2.png",
            "ASSETS/stomyscoffeengotattospace3.png",
            "ASSETS/stomyscoffeengotattospace4.png",
            "ASSETS/stomyscoffeengotattospace5.png",
            "ASSETS/stomyscoffeengotattospace6.png"
        ],
        menu: [
            "ASSETS/stomyscoffeengotattomenu1.png",
            "ASSETS/stomyscoffeengotattomenu2.png",
            "ASSETS/stomyscoffeengotattomenu3.png",
            "ASSETS/stomyscoffeengotattomenu4.png",
            "ASSETS/stomyscoffeengotattomenu5.png",
            "ASSETS/stomyscoffeengotattomenu6.png"
        ],
        group: ["ASSETS/stomyscoffeengotattogroup1.png"]
    },
    communityContributions: [{ user: "Nolan", comment: "Super cute interior, feels like home.", photo: null, time: "15 min ago" }],
    openTime: "08:30", closeTime: "21:30",
    map: "https://maps.app.goo.gl/LywWmxMdCrcyUiWs5",
    address: "167/4 NgÃ´ Táº¥t Tá»‘, P.22, BÃ¬nh Tháº¡nh",
    hotline: "0379540507",
    note: "The cafÃ© is a bit small.",
    isFavorite: false,
    lat: 10.791359757266516, lng: 106.71501275596258, 

    aiCrowdScore: 52,
    finalCrowdScore: 51,
    wifi: "Excellent",
    drinks: "Good",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [20, 45, 55, 50, 35, 15],
        "Tue": [20, 50, 60, 55, 40, 20],
        "Wed": [25, 55, 65, 58, 45, 25],
        "Thu": [25, 58, 68, 60, 50, 30],
        "Fri": [30, 65, 75, 70, 60, 40],
        "Sat": [35, 75, 85, 80, 70, 50],
        "Sun": [40, 80, 80, 70, 55, 35]
    }
},

// ---------- 18 ----------
{ 
    id: 18,
    title: "Coffee Hut",
    images: [
        "ASSETS/coffeehutspace1.png",
        "ASSETS/coffeehutspace2.png",
        "ASSETS/coffeehutspace3.png",
        "ASSETS/coffeehutspace4.png",
        "ASSETS/coffeehutspace5.png",
        "ASSETS/coffeehutspace6.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/coffeehutspace1.png",
            "ASSETS/coffeehutspace2.png",
            "ASSETS/coffeehutspace3.png",
            "ASSETS/coffeehutspace4.png",
            "ASSETS/coffeehutspace5.png",
            "ASSETS/coffeehutspace6.png"
        ],
        menu: [
            "ASSETS/coffeehutmenu1.png",
            "ASSETS/coffeehutmenu2.png",
            "ASSETS/coffeehutmenu3.png",
            "ASSETS/coffeehutmenu4.png",
            "ASSETS/coffeehutmenu5.png",
            "ASSETS/coffeehutmenu6.png",
            "ASSETS/coffeehutmenu7.png"
        ],
        group: ["ASSETS/coffeehutgroup1.png"]
    },
    communityContributions: [{ user: "Clem", comment: "Thanks huhuhu", photo: "ASSETS/coffeehutspace2.png", time: "5 min ago" }],
    openTime: "08:00", closeTime: "21:00",
    map: "https://maps.app.goo.gl/VkcVZyjubtQNpRdm9",
    address: "5 Ä. TrÆ°Æ¡ng Quyá»n, P.6, Q.3",
    hotline: "02822002366",
    note: "Cheaper compared to most places.",
    isFavorite: false,
    lat: 10.786419317410443, lng: 106.69280738834323, 

    aiCrowdScore: 65,
    finalCrowdScore: 59,
    wifi: "Excellent",
    drinks: "Okay",
    service: "Good",
    price: "$",
    crowdDataset: {
        "Mon": [30, 55, 70, 60, 40, 20],
        "Tue": [35, 60, 75, 65, 45, 25],
        "Wed": [35, 65, 78, 68, 50, 30],
        "Thu": [40, 70, 80, 70, 55, 35],
        "Fri": [45, 80, 90, 85, 70, 50],
        "Sat": [50, 90, 95, 90, 80, 60],
        "Sun": [55, 95, 90, 80, 65, 40]
    }
},

// ---------- 19 ----------
{ 
    id: 19,
    title: "Glas Srca Coffee",
    images: [
        "ASSETS/glassrcacoffeespace1.png",
        "ASSETS/glassrcacoffeespace2.png",
        "ASSETS/glassrcacoffeespace3.png",
        "ASSETS/glassrcacoffeespace4.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/glassrcacoffeespace1.png",
            "ASSETS/glassrcacoffeespace2.png",
            "ASSETS/glassrcacoffeespace3.png",
            "ASSETS/glassrcacoffeespace4.png"
        ],
        menu: [
            "ASSETS/glassrcacoffeemenu1.png",
            "ASSETS/glassrcacoffeemenu2.png",
            "ASSETS/glassrcacoffeemenu3.png",
            "ASSETS/glassrcacoffeemenu4.png",
            "ASSETS/glassrcacoffeemenu5.png",
            "ASSETS/glassrcacoffeemenu6.png"
        ],
        group: ["ASSETS/glassrcacoffeegroup1.png"]
    },
    communityContributions: [{ user: "Alma", comment: "Super cute interior, feels like home.", photo: null, time: "10 min ago" }],
    openTime: "06:00", closeTime: "22:00",
    map: "https://maps.app.goo.gl/MWcXkkhnfRZV7Bke7",
    address: "681/9b Ä. Háº­u Giang, P.11, Q.6",
    hotline: "0368141916",
    note: "Cozy indie vibes with a warm, comfortable atmosphere and chill background music.",
    isFavorite: false,
    lat: 10.74701375879124, lng: 106.63345167055192,

    aiCrowdScore: 32,
    finalCrowdScore: 27,
    wifi: "Excellent",
    drinks: "Good",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [10, 25, 35, 30, 20, 10],
        "Tue": [12, 28, 40, 35, 25, 12],
        "Wed": [15, 30, 42, 38, 28, 15],
        "Thu": [15, 35, 45, 40, 30, 18],
        "Fri": [20, 45, 55, 50, 40, 25],
        "Sat": [25, 55, 65, 60, 50, 30],
        "Sun": [30, 60, 65, 55, 40, 20]
    }
},

// ---------- 20 ----------
{ 
    id: 20,
    title: "Keng Cafe",
    images: [
        "ASSETS/kengcafespace1.png",
        "ASSETS/kengcafespace2.png",
        "ASSETS/kengcafespace3.png",
        "ASSETS/kengcafespace4.png"
    ],
    communityGallery: {
        place: [
            "ASSETS/kengcafespace1.png",
            "ASSETS/kengcafespace2.png",
            "ASSETS/kengcafespace3.png",
            "ASSETS/kengcafespace4.png"
        ],
        menu: [
            "ASSETS/kengcafemenu1.png",
            "ASSETS/kengcafemenu2.png",
            "ASSETS/kengcafemenu3.png",
            "ASSETS/kengcafemenu4.png",
            "ASSETS/kengcafemenu5.png"
        ],
        group: ["ASSETS/kengcafegroup1.png"]
    },
    communityContributions: [{ user: "Báº£o TrÃ¢n", comment: "Beautiful view.", photo: null, time: "10 min ago" }],
    openTime: "08:00", closeTime: "23:00",
    map: "https://maps.app.goo.gl/LPjsYPgAo2oJVHkm6",
    address: "136/8 Ä. Váº¡n Kiáº¿p, P.1, BÃ¬nh Tháº¡nh",
    hotline: "0345557659",
    note: "Spacious and airy with a comfortable open feel.",
    isFavorite: false,
    lat: 10.799744994134114, lng: 106.69312932320273, 

    aiCrowdScore: 48,
    finalCrowdScore: 49,
    wifi: "Good",
    drinks: "Good",
    service: "Good",
    price: "$$",
    crowdDataset: {
        "Mon": [20, 40, 50, 45, 30, 15],
        "Tue": [22, 45, 55, 50, 35, 18],
        "Wed": [25, 50, 60, 55, 40, 20],
        "Thu": [25, 55, 65, 58, 45, 25],
        "Fri": [30, 65, 75, 70, 55, 35],
        "Sat": [40, 75, 85, 80, 65, 45],
        "Sun": [45, 80, 80, 70, 55, 30]
    }
}
];

let currentUser = null;
let lastUserRank = null;
let rankToastTimer = null;
let selectedCafe = null;
let compareCafeId = null;
let currentFilter = 'All';

const achievements = [
    { name: "First Check-In", description: "Completed your first check-in!", icon: "ph-fill ph-map-pin", unlocked: true },
    { name: "Photo Contributor", description: "Uploaded a photo to a cafÃ©.", icon: "ph-fill ph-camera", unlocked: false },
    { name: "Cafe Explorer", description: "Visited 5 different cafÃ©s.", icon: "ph-fill ph-compass", unlocked: false },
    { name: "Regular Member", description: "Logged in 7 days in a row.", icon: "ph-fill ph-calendar-check", unlocked: false },
    { name: "Aesthetic Photographer", description: "Uploaded 10 high-quality photos.", icon: "ph-fill ph-image", unlocked: false },
];

const rankingSeed = [
    { name: "Linh Nguyen", xp: 420, checkins: 21, avatar: null },
    { name: "Khai Tran", xp: 360, checkins: 18, avatar: null },
    { name: "Mai Pham", xp: 290, checkins: 16, avatar: null },
    { name: "Hoang Vu", xp: 210, checkins: 12, avatar: null },
    { name: "Nhi Le", xp: 160, checkins: 9, avatar: null }
];

let userLocation = null;
navigator.geolocation.getCurrentPosition(pos => {
    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    renderList();
});

if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
    document.querySelectorAll(".dynamic-island, .phone-notch, .notch").forEach(el => el.remove());
    document.querySelectorAll(".orb").forEach(e => e.remove());
}

function getDistance(lat1, lon1, lat2, lon2) {
    function toRad(v) { return v * Math.PI / 180; }
    var R = 6371;
    var dLat = toRad(lat2 - lat1);
    var dLon = toRad(lon2 - lon1);
    var a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return (R * c).toFixed(1);
}

function getCrowdIcons(score) {
    let count, color;
    if (score < 30) { count = 1; color = '#8EE5C2'; } 
    else if (score < 60) { count = 2; color = '#F5DE8B'; } 
    else if (score < 80) { count = 3; color = '#F2A65A'; } 
    else { count = 4; color = '#E1645A'; }

    let iconsHtml = '';
    for (let i = 0; i < count; i++) {
        iconsHtml += `<i class="ph-fill ph-user" style="color: ${color}; font-size: 14px; margin-right: 2px;"></i>`;
    }
    return iconsHtml;
}

function navTo(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    document.querySelectorAll('.nav-icon').forEach(i => i.classList.remove('active'));
    const map = {'screen-home':0, 'screen-saved':1, 'screen-account':2, 'screen-activity':3, 'screen-settings':4};
    if(map[screenId]!==undefined) document.querySelectorAll('.nav-icon')[map[screenId]].classList.add('active');
    
    const mainNav = document.getElementById('main-nav');
    if (screenId === 'screen-detail') { mainNav.style.display = 'none'; } else { mainNav.style.display = 'flex'; }

    if(screenId === 'screen-home') {
        renderList();
        if(isMapView) {
            document.getElementById('home-list-view').style.display = 'none';
            document.getElementById('home-map-view').style.display = 'block';
            document.getElementById('home-header').style.display = 'none'; // Hide header in Map View
        } else {
             document.getElementById('home-header').style.display = 'flex'; // Show header in List View
        }
    }
    if(screenId === 'screen-saved') renderSaved();
    if(screenId === 'screen-account') renderAccount();
}

function toggleCat(el) { el.classList.toggle('active'); }
function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function openModal(id) { document.getElementById(id).style.display = 'flex'; }
// Fixed Color Logic: Excellent = Green, Good = Blue/Sage
function getMetricColor(val) { if(val==='Excellent') return 'var(--color-green)'; if(val==='Good') return 'var(--color-blue)'; if(val==='Okay') return 'var(--color-orange)'; return 'var(--color-red)'; }
function getPriceColor(val) { return val === '$' ? 'var(--color-green)' : (val === '$$' ? 'var(--color-orange)' : 'var(--color-red)'); }
function getCrowdColor(val) { return val<40 ? 'var(--color-green)' : (val<70 ? 'var(--color-orange)' : 'var(--color-red)'); }


function getOpenStatus(open, close) {
    if ((open === "00:00" && close === "23:59") || (open === "00:00" && close === "00:00")) {
        return { isOpen: true, text: "Open 24/7", class: "status-open", closeText: "" };
    }
    const now = new Date();
    const currentMins = now.getHours() * 60 + now.getMinutes();
    const [oh, om] = open.split(':').map(Number);
    const [ch, cm] = close.split(':').map(Number);
    const startMins = oh * 60 + om;
    let endMins = ch * 60 + cm;
    let isOvernight = false;
    if (endMins <= startMins) { endMins += 1440; isOvernight = true; }
    let current = currentMins;
    if (isOvernight && currentMins < startMins) { current += 1440; }
    const isOpen = current >= startMins && current < endMins;
    
    // Format text
    let statusText = isOpen ? `${open} - ${close}` : `Closed â€¢ Opens ${open}`;
    
    return { isOpen: isOpen, text: statusText, class: isOpen ? "status-open" : "status-closed" };
}

function getCafeStatus(cafe) {
    const res = getOpenStatus(cafe.openTime, cafe.closeTime);
    return res.isOpen ? "open" : "closed";
}

function renderList(filterParam = currentFilter) {
    const container = document.getElementById('cafe-list-container'); 
    if(!container) return;
    currentFilter = filterParam || 'All';
    let data = [...cafes].filter(c => c.title);
    data = sortCafesByFilter(data, currentFilter);
    const limit = getCafeUnlockLimit();
    if (limit) data = data.slice(0, limit);
    const showRanking = currentFilter !== 'All';
    container.innerHTML = '';
    data.forEach((c, index) => {
        container.innerHTML += buildCafeCard(c, {
            rank: showRanking ? index + 1 : null,
            delay: index * 0.05
        });
    });
    if(data.length === 0) { container.innerHTML = "<p style='text-align:center; margin-top:20px; color:var(--text-muted);'>No cafes found.</p>"; }
    updateUnlockBlock();
}

function sortCafesByFilter(list, filter) {
    const data = [...list];
    switch(filter) {
        case 'Crowd':
            data.sort((a, b) => a.finalCrowdScore - b.finalCrowdScore);
            break;
        case 'Wifi':
            data.sort((a, b) => getRatingScore(b.wifi) - getRatingScore(a.wifi));
            break;
        case 'Drinks':
            data.sort((a, b) => getRatingScore(b.drinks) - getRatingScore(a.drinks));
            break;
        case 'Service':
            data.sort((a, b) => getRatingScore(b.service) - getRatingScore(a.service));
            break;
        case 'Price':
            data.sort((a, b) => getPriceScore(b.price) - getPriceScore(a.price));
            break;
        case 'Distance':
            data.sort((a, b) => getCafeDistanceValue(a) - getCafeDistanceValue(b));
            break;
        default:
            break;
    }
    return data;
}

function getCafeDistanceValue(cafe) {
    if(!userLocation || !cafe.lat || !cafe.lng) return Number.POSITIVE_INFINITY;
    const dist = parseFloat(getDistance(userLocation.lat, userLocation.lng, cafe.lat, cafe.lng));
    return isNaN(dist) ? Number.POSITIVE_INFINITY : dist;
}

function getRatingScore(val) {
    const map = { 'Excellent': 4, 'Good': 3, 'Okay': 2, 'Bad': 1 };
    return map[val] || 0;
}

function getPriceScore(val) {
    const map = { '$': 3, '$$': 2, '$$$': 1 };
    return map[val] || 0;
}

function getWifiMeta(level) {
    let icon = "ph-wifi-high";
    let color = "var(--color-green)";
    if(level === "Good") { color = "var(--color-blue)"; }
    else if(level === "Okay") { icon = "ph-wifi-medium"; color = "var(--color-orange)"; }
    else if(level === "Bad") { icon = "ph-wifi-low"; color = "var(--color-red)"; }
    return { icon, color };
}

function buildCafeCard(cafe, options = {}) {
    const { rank = null, delay = 0 } = options;
    const img = cafe.images.length > 0 ? cafe.images[0] : '';
    const status = getOpenStatus(cafe.openTime, cafe.closeTime);
    const wifiMeta = getWifiMeta(cafe.wifi);
    const priceColor = getPriceColor(cafe.price);
    const crowdColor = getCrowdColor(cafe.finalCrowdScore);
    const scheduleText = `${status.isOpen ? 'Open' : 'Close'} Â· ${cafe.openTime} - ${cafe.closeTime}`;
    const isClosed = !status.isOpen;
    const mutedColor = 'var(--text-muted)';
    const wifiColor = isClosed ? mutedColor : wifiMeta.color;
    const priceDisplayColor = isClosed ? mutedColor : priceColor;
    const crowdDisplayColor = isClosed ? mutedColor : crowdColor;
    let distanceText = "Enable location to view distance";
    if (userLocation && cafe.lat && cafe.lng) {
        const dist = getDistance(userLocation.lat, userLocation.lng, cafe.lat, cafe.lng);
        distanceText = `${dist} km away`;
    }
    const distanceMetaClass = `meta-item ${isClosed ? 'meta-muted' : ''}`;
    const goButtonClass = `btn-card-go ${isClosed ? 'disabled' : ''}`;
    const rankBadge = rank ? `<div class="card-rank-badge">#${rank}</div>` : '';
    return `
        <div class="cafe-card ${isClosed ? 'cafe-card-closed' : ''}" onclick="openDetail(${cafe.id})" style="animation-delay: ${delay}s">
            ${rankBadge}
            <img src="${img}" class="card-img" alt="${cafe.title}">
            <div class="card-info">
                <div class="card-title-row">
                    <span class="card-title">${cafe.title}</span>
                </div>
                <div class="card-metrics-row">
                    <div class="metric-pill" style="color:${wifiColor}"><i class="ph-fill ${wifiMeta.icon}"></i>${isClosed ? '' : cafe.wifi}</div>
                    <div class="metric-pill" style="color:${priceDisplayColor}"><i class="ph-fill ph-currency-dollar"></i>${isClosed ? '' : cafe.price}</div>
                    <div class="metric-pill" style="color:${crowdDisplayColor}">${isClosed ? '' : 'Crowd: ' + cafe.finalCrowdScore + '%'}</div>
                </div>
                <div class="card-meta-row">
                    <div class="${distanceMetaClass}"><i class="ph-fill ph-navigation-arrow"></i>${distanceText}</div>
                    <div class="meta-item ${status.isOpen ? 'status-open-text' : 'status-closed-text'}"><i class="ph-fill ph-clock"></i>${scheduleText}</div>
                    <div class="${goButtonClass}" onclick="event.stopPropagation(); openExternalGoogle(${cafe.lat}, ${cafe.lng})">
                        <i class="ph-fill ph-navigation-arrow go-icon" style="font-size:14px;"></i> Go
                    </div>
                </div>
            </div>
        </div>`;
}

function filterList(type, el) { document.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); currentFilter = type; renderList(type); }
function handleSearch(val) { renderList(); }

function renderSaved() {
    const container = document.getElementById('saved-container');
    if(!container) return;
    const savedCafes = cafes.filter(c => c.isFavorite && c.title);
    if(!savedCafes.length) { container.innerHTML = '<p style="text-align:center; margin-top:40px; color:var(--text-muted);">No saved spots yet.</p>'; return; }
    container.innerHTML = '';
    savedCafes.forEach((c, index) => { 
        container.innerHTML += buildCafeCard(c, { delay: index * 0.05 });
    });
}

function initCarousel(images) {
    let index = 0;
    const imgBox = document.getElementById("carouselImage");
    function update() { imgBox.style.backgroundImage = `url('${images[index]}')`; }
    update();
}

let currentGalleryImages = [];
let lightboxIndex = 0;
let lightboxContext = 'gallery'; 
let currentCommunityCategory = 'place';

function renderCommunitySection() {
    const galleryContainer = document.getElementById('community-gallery');
    const timelineContainer = document.getElementById('community-timeline');
    if(!galleryContainer || !timelineContainer || !selectedCafe) return;

    galleryContainer.innerHTML = '';
    currentGalleryImages = [];
    const structuredGallery = selectedCafe.communityGallery || {};
    const categories = [
        { key: 'place', label: 'Place', icon: 'ph-bold ph-map-pin' },
        { key: 'menu', label: 'Menu', icon: 'ph-bold ph-fork-knife' },
        { key: 'group', label: 'Group Study', icon: 'ph-bold ph-users-three' }
    ];
    const hasStructured = categories.some(cat => structuredGallery[cat.key] && structuredGallery[cat.key].length);

    if(hasStructured) {
        const available = categories.filter(cat => structuredGallery[cat.key] && structuredGallery[cat.key].length);
        if(!structuredGallery[currentCommunityCategory] || !structuredGallery[currentCommunityCategory].length) {
            currentCommunityCategory = available.length ? available[0].key : 'place';
        }
        const tabHTML = categories.map(cat => {
            const imgs = structuredGallery[cat.key] || [];
            const active = cat.key === currentCommunityCategory ? 'active' : '';
            const disabled = imgs.length ? '' : 'disabled';
            const countText = imgs.length ? `<span class="category-count">${imgs.length}</span>` : '';
            const icon = `<i class="${cat.icon}"></i>`;
            return `<button class="gallery-tab ${active}" data-cat="${cat.key}" ${disabled} onclick="${imgs.length ? `setCommunityCategory('${cat.key}', true, true)` : ''}">${icon}<span class="label">${cat.label}</span>${countText}</button>`;
        }).join('');
        galleryContainer.innerHTML = `
            <div class="gallery-tabs-wrapper">
                <div class="gallery-tab-bar">${tabHTML}</div>
                <div class="gallery-tab-hint">Tap a category to view</div>
            </div>`;
        setCommunityCategory(currentCommunityCategory, false, false);
    } else {
        if(selectedCafe.images && selectedCafe.images.length > 1) { currentGalleryImages.push(...selectedCafe.images.slice(1)); }
        const userPhotos = (selectedCafe.communityContributions || []).filter(c => c.photo).map(c => c.photo);
        currentGalleryImages.push(...userPhotos);
        if(!currentGalleryImages.length) { galleryContainer.innerHTML = '<p style="color:var(--text-muted); font-size:12px;">No photos yet.</p>'; }
        currentGalleryImages.forEach((src, index) => {
            galleryContainer.innerHTML += `<div class="gallery-item-wrapper" onclick="openLightboxGallery(${index})"><img src="${src}" class="gallery-item" loading="lazy"></div>`;
        });
    }

    timelineContainer.innerHTML = '';
    const contributions = selectedCafe.communityContributions || [];
    if(!contributions.length) {
        timelineContainer.innerHTML = '<p style="color:var(--text-muted); font-size:12px;">No contributions yet.</p>';
    } else {
        contributions.forEach(c => {
            let imgHTML = c.photo ? `<img src="${c.photo}" class="contribution-img" onclick="openLightboxSingle('${c.photo}')">` : '';
            timelineContainer.innerHTML += `<div class="timeline-item"><div class="timeline-dot"></div><div class="comment-box"><b style="color:var(--accent-cyan)">${c.user}</b> <span style="color:var(--text-white)">${c.comment}</span><br><span style="font-size:11px; color:var(--text-muted)">${c.time}</span>${imgHTML}</div></div>`;
        });
    }
}

function setCommunityCategory(cat, openLightbox = true, setActive = true) {
    currentCommunityCategory = cat;
    if(!selectedCafe || !selectedCafe.communityGallery) return;
    const imgs = selectedCafe.communityGallery[cat] || [];
    currentGalleryImages = imgs.slice();
    const tabs = document.querySelectorAll('.gallery-tab');
    if(setActive) {
        tabs.forEach(btn => {
            if(btn.dataset.cat === cat) { btn.classList.add('active'); }
            else { btn.classList.remove('active'); }
        });
    } else {
        tabs.forEach(btn => btn.classList.remove('active'));
    }
    if(openLightbox && imgs.length) { openLightboxGallery(0); }
}

function openLightboxGallery(startIndex) { if(currentGalleryImages.length === 0) return; lightboxContext = 'gallery'; lightboxIndex = startIndex; document.querySelector('.lightbox-prev').style.display = 'flex'; document.querySelector('.lightbox-next').style.display = 'flex'; document.getElementById('lightbox-dots').style.display = 'flex'; updateLightboxUI(); const lb = document.getElementById('lightbox'); lb.classList.add('active'); lb.style.display = 'flex'; }
function openLightboxSingle(src) { lightboxContext = 'single'; document.getElementById('lightbox-image').src = src; document.querySelector('.lightbox-prev').style.display = 'none'; document.querySelector('.lightbox-next').style.display = 'none'; document.getElementById('lightbox-dots').style.display = 'none'; const lb = document.getElementById('lightbox'); lb.classList.add('active'); lb.style.display = 'flex'; }
function updateLightboxUI() { const img = document.getElementById('lightbox-image'); img.src = currentGalleryImages[lightboxIndex]; const dotsContainer = document.getElementById('lightbox-dots'); dotsContainer.innerHTML = ''; currentGalleryImages.forEach((_, i) => { dotsContainer.innerHTML += `<div class="lightbox-dot ${i === lightboxIndex ? 'active' : ''}"></div>`; }); }
function changeLightboxImage(direction) { if(lightboxContext !== 'gallery') return; lightboxIndex += direction; if(lightboxIndex >= currentGalleryImages.length) lightboxIndex = 0; if(lightboxIndex < 0) lightboxIndex = currentGalleryImages.length - 1; updateLightboxUI(); }
function closeLightbox() { 
    const lb = document.getElementById('lightbox'); 
    lb.classList.remove('active'); 
    // Clear tab highlight when exiting full screen
    document.querySelectorAll('.gallery-tab').forEach(btn => btn.classList.remove('active'));
    setTimeout(() => lb.style.display = 'none', 300); 
}
let touchStartX = 0; let touchEndX = 0; const lightboxEl = document.getElementById('lightbox');
lightboxEl.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
lightboxEl.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
function handleSwipe() { if(lightboxContext !== 'gallery') return; const threshold = 50; if (touchEndX < touchStartX - threshold) changeLightboxImage(1); if (touchEndX > touchStartX + threshold) changeLightboxImage(-1); }

function openDetail(id) {
    selectedCafe = cafes.find(c => c.id === id);
    document.getElementById('detail-title').innerText = selectedCafe.title;
    document.getElementById('detail-address').innerText = selectedCafe.address;
    document.getElementById('detail-hotline').innerText = selectedCafe.hotline || "No hotline";
    document.getElementById('detail-note').innerText = selectedCafe.note;
    const status = getOpenStatus(selectedCafe.openTime, selectedCafe.closeTime);
    if (status.text === "Open 24/7") { document.getElementById('detail-status').innerHTML = `<span class="${status.class}">${status.text}</span>`; } 
    else { document.getElementById('detail-status').innerHTML = `<span class="${status.class}">${status.text}</span>`; }
    updateHeartIcon(); 
    document.getElementById('detail-wifi').innerText = selectedCafe.wifi; document.getElementById('detail-wifi').style.color = getMetricColor(selectedCafe.wifi);
    document.getElementById('detail-drinks').innerText = selectedCafe.drinks; document.getElementById('detail-drinks').style.color = getMetricColor(selectedCafe.drinks);
    document.getElementById('detail-service').innerText = selectedCafe.service; document.getElementById('detail-service').style.color = getMetricColor(selectedCafe.service);
    document.getElementById('detail-price').innerText = selectedCafe.price; document.getElementById('detail-price').style.color = getPriceColor(selectedCafe.price);
    
    // Real-time Hour Logic for Chart
    const nowHour = new Date().getHours();
    const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const currentDay = days[new Date().getDay()];
    // Set dropdown to today
    document.getElementById('chart-day-select').value = currentDay;
    renderChart(currentDay);
    
    renderCommunitySection();
    const heroImage = selectedCafe.images.length ? [selectedCafe.images[0]] : ["https://via.placeholder.com/400x300?text=No+Image"];
    initCarousel(heroImage);
    const checkinBtn = document.getElementById('checkin-btn');
    if (checkinBtn) {
        checkinBtn.classList.remove('attention');
        void checkinBtn.offsetWidth;
        checkinBtn.classList.add('attention');
    }
    navTo('screen-detail');
}

function toggleFavorite() { if(!selectedCafe) return; selectedCafe.isFavorite = !selectedCafe.isFavorite; updateHeartIcon(); if(document.getElementById('screen-saved').classList.contains('active')) renderSaved(); }
function updateHeartIcon() { const icon = document.querySelector('#like-btn i'); if (selectedCafe.isFavorite) { icon.className = "ph-fill ph-heart"; icon.style.color = "var(--color-red)"; } else { icon.className = "ph ph-heart"; icon.style.color = "#ffffff"; } }

function renderChart(day) {
    if(!selectedCafe) return;
    const container = document.getElementById('crowd-chart'); container.innerHTML = '';
    
    // Time Slots: 8, 11, 14, 17, 20, 22
    const labels = ["8am", "11am", "2pm", "5pm", "8pm", "10pm"];
    const values = selectedCafe.crowdDataset[day] || selectedCafe.crowdDataset["Mon"];
    
    // Determine Current Hour Index
    const h = new Date().getHours();
    let currentHourIndex = -1;
    if (h >= 8 && h < 11) currentHourIndex = 0;
    else if (h >= 11 && h < 14) currentHourIndex = 1;
    else if (h >= 14 && h < 17) currentHourIndex = 2;
    else if (h >= 17 && h < 20) currentHourIndex = 3;
    else if (h >= 20 && h < 22) currentHourIndex = 4;
    else if (h >= 22 || h < 4) currentHourIndex = 5;

    values.forEach((val, i) => { 
        const isLive = i === currentHourIndex; 
        const activeClass = isLive ? 'active' : ''; 
        container.innerHTML += `<div class="bar-col ${activeClass}" onclick="toggleBar(this)"><div class="bar" style="height:${val}%;"></div><span class="bar-label">${labels[i]}</span></div>`; 
    });
}
function toggleBar(el) { document.querySelectorAll('.bar-col').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
function openGoogleMaps() {
    if (!selectedCafe) return;
    const url = `https://www.google.com/maps/dir/?api=1&destination=${selectedCafe.lat},${selectedCafe.lng}`;
    window.open(url, "_blank");
}
// Allow direct map link from card
function openExternalGoogle(lat, lng) {
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
}

function openCheckInModal() {
    if(!currentUser) { document.getElementById('login-msg').innerText = "Sign in to Check-In."; openModal('modal-login'); }
    else { 
        const container = document.getElementById('crowd-input-bars'); container.innerHTML = '';
        for(let i=1; i<=5; i++) container.innerHTML += `<div class="input-bar" id="ibar-${i}" onclick="setInputCrowd(${i})" style="height:${i*20}%"></div>`;
        document.getElementById('checkin-feedback').value = ""; document.getElementById('checkin-file-input').value = ""; openModal('modal-checkin-form'); 
    }
}
function setInputCrowd(l) { for(let i=1; i<=5; i++) document.getElementById(`ibar-${i}`).classList.toggle('filled', i<=l); }

function submitCheckInForm() {
    const fileInput = document.getElementById('checkin-file-input');
    const feedbackRaw = document.getElementById('checkin-feedback').value;
    const feedbackText = feedbackRaw || "Updated status";
    const hasFile = fileInput.files && fileInput.files[0];
    const finishSubmit = (imageSrc = null) => {
        const prevRank = getCurrentUserRank();
        const prevBonus = getUnlockBonusByRank(prevRank);
        const newContribution = { user: currentUser.name, comment: feedbackText, photo: imageSrc, time: "Just now" };
        if(selectedCafe) { if(!selectedCafe.communityContributions) selectedCafe.communityContributions = []; selectedCafe.communityContributions.unshift(newContribution); }
        let justUnlocked = false;
        const feedbackBonus = feedbackRaw.trim() ? 20 : 0;
        const photoBonus = hasFile ? 30 : 0;
        const earnedXp = 50 + feedbackBonus + photoBonus;
        const xpAmountEl = document.getElementById('xp-amount');
        if (xpAmountEl) xpAmountEl.textContent = `+${earnedXp} XP`;
        closeModal('modal-checkin-form'); openModal('modal-xp'); currentUser.xp += earnedXp; currentUser.checkins++;
        const newRank = getCurrentUserRank();
        const newBonus = getUnlockBonusByRank(newRank);
        if (newBonus > prevBonus) {
            justUnlocked = true;
            const unlockedCount = newBonus - prevBonus;
            const unlockText = document.getElementById('unlock-count-text');
            if (unlockText) unlockText.textContent = `You just unlocked ${unlockedCount} new cafes.`;
            const unlockList = document.getElementById('unlock-list');
            if (unlockList) {
                const allData = [...cafes].filter(c => c.title);
                const prevLimit = 10 + prevBonus;
                const newLimit = 10 + newBonus;
                const newItems = allData.slice(prevLimit, newLimit);
                unlockList.innerHTML = newItems.map(c => `<div class="unlock-pill">${c.title}</div>`).join('');
            }
            renderList();
        }
        const isRankUp = prevRank && newRank && newRank < prevRank;
        lastUserRank = newRank;
        setTimeout(() => { 
            closeModal('modal-xp'); 
            if(selectedCafe && document.getElementById('screen-detail').classList.contains('active')) { renderCommunitySection(); } 
            
            // IF JUST UNLOCKED, SHOW CONGRATS MODAL - Faster disappear
            if (isRankUp) showRankToast(newRank);
            if(justUnlocked) {
                const delay = isRankUp ? 2100 : 0;
                setTimeout(() => {
                    openModal('modal-unlock-congrats');
                    setTimeout(() => closeModal('modal-unlock-congrats'), 3000); // 3 seconds
                }, delay);
            }
        }, 1500);
    };
    if(hasFile) { const reader = new FileReader(); reader.onload = function(e) { finishSubmit(e.target.result); }; reader.readAsDataURL(fileInput.files[0]); } else { finishSubmit(null); }
}

function openCompareSelection() {
    if(!currentUser) { document.getElementById('login-msg').innerText = "Sign in to compare."; openModal('modal-login'); return; }
    const list = document.getElementById('compare-list'); list.innerHTML = '';
    cafes.filter(c => c.id !== selectedCafe.id && c.title !== "").forEach(c => { const img = c.images.length > 0 ? c.images[0] : ''; list.innerHTML += `<div class="compare-item" onclick="startCompare(${c.id})"><img src="${img}" style="width:40px; height:40px; border-radius:8px; object-fit:cover;"><b>${c.title}</b></div>`; });
    openModal('screen-compare-select');
}
function startCompare(otherId) {
    compareCafeId = otherId; const otherCafe = cafes.find(c => c.id === otherId);
    closeModal('screen-compare-select'); navTo('screen-compare-result');
    document.getElementById('cmp-img-1').src = selectedCafe.images[0] || ''; document.getElementById('cmp-title-1').innerText = selectedCafe.title; renderCompData(1, selectedCafe);
    document.getElementById('cmp-img-2').src = otherCafe.images[0] || ''; document.getElementById('cmp-title-2').innerText = otherCafe.title; renderCompData(2, otherCafe);
    document.getElementById('btn-goto-a').innerText = "Go to " + selectedCafe.title; document.getElementById('btn-goto-b').innerText = "Go to " + otherCafe.title;
}
function renderCompData(idx, c) { const set = (k, v, color) => { const el = document.getElementById(`cmp-${k}-${idx}`); el.innerText = v; el.style.color = color; }; set('wifi', c.wifi, getMetricColor(c.wifi)); set('drinks', c.drinks, getMetricColor(c.drinks)); set('service', c.service, getMetricColor(c.service)); set('price', c.price, getPriceColor(c.price)); set('crowd', c.finalCrowdScore+"%", getCrowdColor(c.finalCrowdScore)); }
function goToCafeB() { openDetail(compareCafeId); }

function renderAchievements() {
    const container = document.getElementById('achievements-container');
    if(!container) return;
    let html = '<h2 style="font-size: 16px; margin-bottom: 12px; color: var(--text-white); padding-left: 4px;">Achievements</h2><div class="achievements-scroll">';
    achievements.forEach(a => {
        const isLocked = !a.unlocked;
        const lockClass = isLocked ? 'locked' : '';
        const lockIcon = isLocked ? '<i class="ph-fill ph-lock-key" style="position:absolute; top:12px; right:12px; color:var(--text-white); z-index:2;"></i>' : '';
        const activeIconColor = isLocked ? 'var(--text-muted)' : 'var(--accent-cyan)';
        html += `<div class="achievement-card ${lockClass}">${lockIcon}<div class="achievement-icon-box" style="color:${activeIconColor}"><i class="${a.icon}"></i></div><div style="font-size:13px; font-weight:700; color:var(--text-white); line-height:1.2;">${a.name}</div><div style="font-size:11px; color:var(--text-muted); line-height:1.3;">${a.description}</div></div>`;
    });
    html += '</div>';
    container.innerHTML = html;
}

function getCurrentUserRank() {
    if (!currentUser) return null;
    const data = getRankingData();
    const idx = data.findIndex(u => u.name === currentUser.name);
    return idx >= 0 ? idx + 1 : null;
}

function getUnlockBonusByRank(rank) {
    if (rank === 1) return 10;
    if (rank === 2) return 5;
    if (rank === 3) return 3;
    return 0;
}

function getCafeUnlockLimit() {
    const base = 10;
    if (!currentUser) return base;
    const rank = getCurrentUserRank();
    const bonus = getUnlockBonusByRank(rank);
    return base + bonus;
}

function updateUnlockBlock() {
    const block = document.getElementById('home-unlock-block');
    if (!block) return;
    const rank = getCurrentUserRank();
    const bonus = getUnlockBonusByRank(rank);
    block.style.display = currentUser && bonus > 0 ? 'none' : 'block';
}

function showRankToast(newRank) {
    const titleEl = document.getElementById('rank-amount');
    const subEl = document.getElementById('rank-sub');
    if (titleEl) titleEl.textContent = `Rank up! #${newRank}`;
    if (subEl) subEl.textContent = 'You climbed the leaderboard.';
    openModal('modal-rank');
    if (rankToastTimer) clearTimeout(rankToastTimer);
    rankToastTimer = setTimeout(() => closeModal('modal-rank'), 2000);
}

function getRankingData() {
    const data = rankingSeed.map(u => ({ ...u }));
    if (currentUser) {
        const existingIndex = data.findIndex(u => u.name === currentUser.name);
        const userEntry = {
            name: currentUser.name,
            xp: currentUser.xp,
            checkins: currentUser.checkins,
            avatar: currentUser.avatar,
            isCurrent: true
        };
        if (existingIndex >= 0) data[existingIndex] = userEntry;
        else data.push(userEntry);
    }
    const withPoints = data.map(u => ({ ...u, points: u.xp + (u.checkins * 20) }));
    const current = withPoints.find(u => u.isCurrent);
    if (current && current.checkins >= 1) {
        const others = withPoints.filter(u => !u.isCurrent);
        const otherPoints = others.map(o => o.points).sort((a, b) => b - a);
        const desiredRank = current.checkins >= 3 ? 1 : current.checkins === 2 ? 2 : 3;
        if (desiredRank === 1 && otherPoints.length) {
            current.points = otherPoints[0] + 50;
        } else {
            const upper = otherPoints[desiredRank - 2] ?? (otherPoints[0] ?? current.points + 10);
            const lower = otherPoints[desiredRank - 1] ?? (upper - 10);
            let target = Math.floor((upper + lower) / 2);
            if (target >= upper) target = upper - 1;
            if (target <= lower) target = lower + 1;
            current.points = target;
        }
    }
    return withPoints.sort((a, b) => b.points - a.points);
}

function renderRanking() {
    const container = document.getElementById('ranking-container');
    if (!container) return;
    const data = getRankingData().slice(0, 5);
    let html = '<div class="ranking-card"><div class="ranking-header"><div class="ranking-title">Leaderboard</div><div class="ranking-sub">Points = XP + Check-ins x 20</div></div><div class="ranking-list">';
    data.forEach((u, i) => {
        const avatarHTML = (u.avatar && (u.avatar.startsWith('http') || u.avatar.startsWith('data:image')))
            ? `<img src="${u.avatar}" style="width:100%; height:100%; object-fit:cover;">`
            : `<i class="ph-fill ph-user"></i>`;
        const topClass = i === 0 ? ' top-1' : i === 1 ? ' top-2' : i === 2 ? ' top-3' : '';
        const youClass = u.isCurrent ? ' ranking-item you' : ' ranking-item';
        html += `<div class="${youClass}${topClass}"><div class="ranking-rank">#${i + 1}</div><div class="ranking-avatar">${avatarHTML}</div><div class="ranking-meta"><div class="ranking-name">${u.name}${u.isCurrent ? ' (You)' : ''}</div><div class="ranking-detail">${u.checkins} check-ins</div></div><div class="ranking-points">${u.points} pts</div></div>`;
    });
    html += '</div></div>';
    container.innerHTML = html;
    lastUserRank = getCurrentUserRank();
}


function renderAccount() {
    const el = document.getElementById('account-content');
    if(!currentUser) { 
        el.style.minHeight = 'calc(100vh - 160px)';
        el.style.justifyContent = 'center';
        el.innerHTML = `<div class="col center" style="margin-top:60px; text-align:center; gap: 16px;"><div class="profile-avatar" style="width:80px; height:80px; font-size:32px;"><i class="ph-fill ph-user"></i></div><h2 style="color:var(--text-white)">Join StudySpot</h2><p style="font-size:13px; max-width:200px;">Track your study sessions and unlock exclusive badges.</p><button class="btn btn-primary" onclick="openLoginModal()" style="width:160px;">Sign In</button></div>`; 
    } else { 
        el.style.minHeight = '0';
        el.style.justifyContent = 'flex-start';
        const level = Math.floor(currentUser.xp / 100) + 1; const progress = currentUser.xp % 100; const nextLevelXP = 100;
        let avatarHTML = ''; if(currentUser.avatar && currentUser.avatar.startsWith('http') || currentUser.avatar && currentUser.avatar.startsWith('data:image')) { avatarHTML = `<img src="${currentUser.avatar}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`; } else { avatarHTML = `<i class="ph-fill ph-user"></i>`; }
        // UPDATED LAYOUT: Spacer reduced to 30px
        el.innerHTML = `<div style="width:100%; height:60px; background:transparent;"></div><div class="col center" style="width:100%; padding: 0 24px 20px;"><div class="profile-avatar">${avatarHTML}<div class="avatar-edit-btn" onclick="document.getElementById('avatar-upload').click()"><i class="ph-bold ph-pencil-simple"></i></div><input type="file" id="avatar-upload" style="display:none" accept="image/*" onchange="handleAvatarChange(this)"></div><h2 style="font-size: 24px; margin-bottom: 4px; color: var(--text-white);">${currentUser.name}</h2><div class="level-badge">Level ${level} Explorer</div><div style="width:100%; margin-top: 24px; margin-bottom: 30px;"><div class="row" style="justify-content:space-between; font-size:12px; margin-bottom:8px; color:var(--text-muted);"><span class="xp-text-label"><b>${currentUser.xp}</b> XP Earned</span><span class="xp-text-label">Next: ${nextLevelXP} XP</span></div><div class="xp-bar-bg"><div class="xp-bar-fill" style="width: ${progress}%; background:var(--accent-cyan); height:100%; box-shadow: 0 0 10px var(--accent-cyan);"></div></div></div><div class="stats-grid"><div class="stat-card"><i class="ph-fill ph-map-pin" style="color:var(--accent-cyan); font-size:20px;"></i><b style="font-size:18px; color:var(--text-white);">${currentUser.checkins}</b><span style="font-size:11px; color:var(--text-muted);">Check-ins</span></div><div class="stat-card"><i class="ph-fill ph-heart" style="color:var(--color-red); font-size:20px;"></i><b style="font-size:18px; color:var(--text-white);">${cafes.filter(c=>c.isFavorite).length}</b><span style="font-size:11px; color:var(--text-muted);">Saved</span></div><div class="stat-card"><i class="ph-fill ph-camera" style="color:var(--color-orange); font-size:20px;"></i><b style="font-size:18px; color:var(--text-white);">${selectedCafe ? (selectedCafe.communityContributions ? selectedCafe.communityContributions.filter(c => c.photo).length : 0) : 0}</b><span style="font-size:11px; color:var(--text-muted);">Photos</span></div></div><div id="ranking-container" style="width:100%; margin-bottom: 24px;"></div><div id="achievements-container" style="width:100%; padding-bottom: 20px;"></div></div>`;
        renderRanking();
        renderAchievements();
    }
}

/* --- UPDATED LOGIN LOGIC --- */
function loginUser() { 
    // Initialize user profile
    currentUser = { name: "Alex", xp: 120, checkins: 0, avatar: null }; 
    lastUserRank = getCurrentUserRank();
    closeModal('modal-login'); 
    
    // UPDATED: Open the new Instruction Modal
    openModal('modal-instruction');
    
    if(document.getElementById('screen-account').classList.contains('active')) renderAccount(); 
    if(document.getElementById('screen-home').classList.contains('active')) renderList(); 
}

function socialLogin(provider) { alert(`Feature ${provider} coming soon!`); loginUser(); }
function handleAvatarChange(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { currentUser.avatar = e.target.result; renderAccount(); }; reader.readAsDataURL(input.files[0]); } }
function logout() { currentUser = null; lastUserRank = null; location.reload(); }
function openLoginModal() { document.getElementById('login-msg').innerText = "Sign in to access features."; openModal('modal-login'); }

/* --- HOME SCREEN MAP LOGIC --- */
let homeMap = null;
let isMapView = false;

function setHomeMode(mode) {
    const listView = document.getElementById('home-list-view');
    const mapView = document.getElementById('home-map-view');
    const btnList = document.getElementById('btn-list-mode');
    const btnMap = document.getElementById('btn-map-mode');
    const header = document.getElementById('home-header');

    if (mode === 'map') {
        isMapView = true;
        header.style.display = 'none'; // Hide Search/Chips
        listView.style.display = 'none';
        mapView.style.display = 'block';
        mapView.style.height = '100vh'; // Full Height
        btnList.classList.remove('active');
        btnMap.classList.add('active');
        if (!homeMap) initDiscoveryMap();
    } else {
        isMapView = false;
        header.style.display = 'flex'; // Show Search/Chips
        listView.style.display = 'block';
        mapView.style.display = 'none';
        btnList.classList.add('active');
        btnMap.classList.remove('active');
    }
}

function toggleHomeView() {
    // Legacy support if button calls this directly
    if (isMapView) setHomeMode('list');
    else setHomeMode('map');
}


function initDiscoveryMap() {
    // Default Center (HCMC)
    homeMap = L.map('discovery-map', { zoomControl: false }).setView([10.7769, 106.7009], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(homeMap);

    // Add markers for all cafes
    cafes.forEach(cafe => {
        if (!cafe.lat || !cafe.lng) return;

        // Color based on Crowd Score
        let color = '#27ae60'; // Green
        if (cafe.finalCrowdScore > 70) color = '#C85555'; // Red
        else if (cafe.finalCrowdScore > 40) color = '#F2A65A'; // Orange

        const customIcon = L.divIcon({
            className: 'custom-pin',
            html: `<div class="marker-pin" style="background-color: ${color}; white-space:nowrap; padding:0 4px; width:auto; min-width:34px;"><b>${cafe.finalCrowdScore}%</b></div>`,
            iconSize: [34, 34],
            iconAnchor: [17, 17]
        });

        const marker = L.marker([cafe.lat, cafe.lng], { icon: customIcon }).addTo(homeMap);

        const popupContent = `
            <div style="text-align:center; min-width: 150px;">
                <b style="font-size:14px;">${cafe.title}</b><br>
                <div style="font-size:11px; color:#666; margin:4px 0;">${cafe.address}</div>
                <div style="display:flex; gap:5px; margin-top:8px;">
                    <button onclick="openDetail(${cafe.id})" style="flex:1; padding:8px; background:#2A2A2A; color:#fff; border:none; border-radius:8px; font-size:12px; cursor:pointer;">Details</button>
                    <button onclick="openExternalGoogle(${cafe.lat}, ${cafe.lng})" style="flex:1; padding:8px; background:#4285F4; color:#fff; border:none; border-radius:8px; font-size:12px; cursor:pointer;">Go â†—</button>
                </div>
            </div>
        `;
        marker.bindPopup(popupContent);
    });
    
    // User Location Dot
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const userIcon = L.divIcon({ className: 'user-dot', iconSize: [16, 16] });
            L.marker([lat, lng], { icon: userIcon }).addTo(homeMap);
            homeMap.setView([lat, lng], 14);
        });
    }
}

function openExternalGoogle(lat, lng) {
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`, '_blank');
}

document.addEventListener("DOMContentLoaded", () => {
    renderList();
    const chartSelect = document.getElementById('chart-day-select');
    if(chartSelect) chartSelect.addEventListener('change', function() { renderChart(this.value); });
});
</script>
</body>
</html>
